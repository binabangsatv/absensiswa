<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Pintar</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            primary: '#738862', // Indigo 600
            secondary: '#10B981', // Emerald 500
            dark: '#111827', // Gray 900
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

    /* Animations */
    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Glass Effect */
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    /* View State */
    .view-section { display: none; }
    .view-section.active { display: block; }

    /* Table Styles */
    .table-header { @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0; }
    .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-b border-gray-100; }
  </style>
</head>
<body class="bg-slate-900 font-sans antialiased text-slate-800 selection:bg-indigo-500 selection:text-white overflow-x-hidden">

<div id="loginPage" class="relative min-h-screen flex items-center justify-center p-4 overflow-hidden bg-slate-950">
    
    <div class="absolute inset-0 z-0">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950"></div>
        
        <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] "></div>
        
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-700 rounded-full mix-blend-multiply filter blur-[128px] opacity-20 animate-pulse"></div>
        
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-cyan-700 rounded-full mix-blend-multiply filter blur-[128px] opacity-20 animate-pulse" style="animation-delay: 2s"></div>
    </div>

    <div class="relative z-10 w-full max-w-5xl bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/5 flex flex-col lg:flex-row animate-fade-in ring-1 ring-white/10">
        
        <div class="w-full lg:w-5/12 relative p-10 flex flex-col justify-between text-white overflow-hidden group">
            <div class="absolute inset-0 bg-cover bg-center transition-transform duration-1000 group-hover:scale-105" 
                 style="background-image: url('https://i.ibb.co.com/Fk7y91Qp/sekolah.png');"></div>
            
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/95 via-slate-900/70 to-slate-900/40"></div>
            
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/20 shadow-lg">
                        <i class="fas fa-school text-xl text-blue-200"></i>
                    </div>
                    <span class="font-bold tracking-wider text-sm text-blue-100/90">SMP BINA BANGSA 2</span>
                </div>
                
                <h1 class="text-4xl lg:text-5xl font-bold leading-tight mb-4 text-white drop-shadow-sm">
                    Sistem Absensi <br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-cyan-200">Digital</span>
                </h1>
                <p class="text-slate-300 text-sm leading-relaxed max-w-xs font-light">
                    Platform manajemen kehadiran siswa yang terintegrasi, aman, dan real-time.
                </p>
            </div>

            <div class="relative z-10 mt-10">
                <div class="flex gap-2 mb-4">
                    <span class="h-1 w-8 bg-blue-400 rounded-full"></span>
                    <span class="h-1 w-2 bg-white/20 rounded-full"></span>
                    <span class="h-1 w-2 bg-white/20 rounded-full"></span>
                </div>
                <div class="flex gap-4 text-xs font-medium text-slate-300">
                    <div class="px-3 py-1.5 rounded-lg bg-black/20 backdrop-blur-md border border-white/5 flex items-center gap-2">
                        <i class="fas fa-shield-alt text-blue-400"></i> Secure
                    </div>
                    <div class="px-3 py-1.5 rounded-lg bg-black/20 backdrop-blur-md border border-white/5 flex items-center gap-2">
                        <i class="fas fa-bolt text-cyan-400"></i> Fast
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-7/12 bg-white p-8 lg:p-12 flex flex-col justify-center relative">
            
            <div class="max-w-md mx-auto w-full">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">Selamat Datang</h2>
                    <p class="text-slate-500 text-sm mt-2">Silakan masuk menggunakan akun Anda</p>
                </div>

                <div class="bg-slate-100 p-1.5 rounded-xl flex mb-8 border border-slate-200 relative">
                    <button id="btnSiswaTab" onclick="switchLoginTab('siswa')" class="flex-1 py-3 text-sm font-bold rounded-lg shadow-sm bg-white text-blue-700 ring-1 ring-black/5 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-user-graduate"></i> Siswa
                    </button>
                    <button id="btnAdminTab" onclick="switchLoginTab('admin')" class="flex-1 py-3 text-sm font-medium rounded-lg text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-chalkboard-teacher"></i> Guru / Admin
                    </button>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-5">
                    
                    <div id="formSiswaLogin" class="animate-fade-in">
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 ml-1">NISN Siswa</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-blue-600 transition-colors">
                                <i class="far fa-id-card text-lg"></i>
                            </div>
                            <input type="number" id="nisn" class="block w-full pl-12 pr-4 py-4 bg-slate-50 border-slate-200 border rounded-xl text-slate-900 text-sm focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder-slate-400" placeholder="Masukkan Nomor Induk Siswa">
                        </div>
                    </div>
                    
                    <div id="formAdminLogin" class="hidden space-y-5 animate-fade-in">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 ml-1">Username</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-blue-600 transition-colors">
                                    <i class="far fa-user text-lg"></i>
                                </div>
                                <input type="text" id="username" class="block w-full pl-12 pr-4 py-4 bg-slate-50 border-slate-200 border rounded-xl text-slate-900 text-sm focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder-slate-400" placeholder="Username akun">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-700 uppercase tracking-wider mb-2 ml-1">Password</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-blue-600 transition-colors">
                                    <i class="fas fa-lock text-lg"></i>
                                </div>
                                <input type="password" id="password" class="block w-full pl-12 pr-12 py-4 bg-slate-50 border-slate-200 border rounded-xl text-slate-900 text-sm focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder-slate-400" placeholder="••••••••">
                                <div class="absolute inset-y-0 right-0 pr-4 flex items-center cursor-pointer text-slate-400 hover:text-blue-600 transition-colors" onclick="togglePassword()">
                                    <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full py-4 px-6 bg-gradient-to-r from-blue-700 to-blue-800 hover:from-blue-800 hover:to-blue-900 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-all transform active:scale-[0.98] text-sm flex justify-center items-center gap-2 group">
                        <span>MASUK SEKARANG</span> 
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>
                
                <div id="loginError" class="mt-6 hidden p-4 bg-red-50 border border-red-100 rounded-xl flex items-start gap-3 animate-fade-in">
                    <div class="p-2 bg-red-100 rounded-full text-red-600 shrink-0">
                        <i class="fas fa-exclamation-triangle text-xs"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-red-700">Akses Ditolak</h4>
                        <p id="errorText" class="text-xs text-red-600 mt-0.5">Username atau password salah.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <p class="absolute bottom-6 text-slate-500 text-xs font-medium opacity-60">
        © 2026 Sistem Absensi Sekolah. v2.0
    </p>
</div>

  <div id="dashboardContainer" class="hidden flex h-screen overflow-hidden bg-[#F3F4F6]">
      
      <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 text-white transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out flex flex-col h-full shadow-2xl border-r border-indigo-900/30" style="background-color: rgb(26, 25, 103);">
          
          <div id="sidebarHeader" class="h-16 flex items-center justify-start px-6 border-b border-indigo-900/50 overflow-hidden relative transition-all duration-300">
              <div class="absolute top-0 left-0 w-full h-full bg-white/5 pointer-events-none"></div>
              <div class="flex items-center space-x-3 relative z-10 w-full">
                  <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-900/50 shrink-0 transition-all duration-300">
                      <i class="fas fa-qrcode text-sm"></i>
                  </div>
                  <div class="sidebar-label transition-opacity duration-300 whitespace-nowrap">
                      <h1 class="font-bold text-base tracking-wide text-white">E-ABSENSI</h1>
                      <p class="text-[9px] text-indigo-200 uppercase tracking-wider font-semibold">SMP BINA BANGSA 2 SBY</p>
                  </div>
              </div>
          </div>
     
          <div class="p-4 overflow-hidden transition-all duration-300">
              <div id="userProfileCard" class="flex items-center space-x-3 p-3 bg-black/20 rounded-xl border border-white/10 transition-all duration-300 overflow-hidden">
                  <div id="navUserInitial" class="w-8 h-8 rounded-lg bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center font-bold text-sm shadow-inner shrink-0 text-white">U</div>
                  <div id="userInfo" class="sidebar-label transition-opacity duration-300 whitespace-nowrap">
                      <p id="navUserName" class="font-semibold text-xs truncate text-white max-w-[120px]">User</p>
                      <span id="navUserRole" class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold uppercase bg-indigo-800 text-indigo-100 border border-indigo-700 tracking-wider">Role</span>
                  </div>
              </div>
          </div>
         
          <nav id="sidebarMenu" class="flex-1 overflow-y-auto overflow-x-hidden px-3 space-y-1 pb-4 scrollbar-hide text-sm"></nav>
          
          <div class="p-4 border-t border-indigo-900/50 bg-black/10">
              <button onclick="logout()" id="btnLogout" class="flex items-center space-x-3 text-red-300 hover:text-white hover:bg-red-500/20 w-full p-2.5 rounded-lg transition duration-200 group overflow-hidden whitespace-nowrap justify-start">
                  <i class="fas fa-sign-out-alt w-5 text-center shrink-0 group-hover:scale-110 transition-transform text-sm"></i>
                  <span class="sidebar-label font-medium transition-opacity duration-300 text-xs">Keluar Aplikasi</span>
              </button>
          </div>
      </aside>

      <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-30 hidden transition-opacity duration-300 opacity-0"></div>

      <main id="mainContent" class="flex-1 flex flex-col md:ml-64 h-screen relative transition-all duration-300 overflow-hidden bg-[#F3F4F6]">
          
          <header class="h-16 bg-white/80 backdrop-blur-xl sticky top-0 z-20 flex items-center justify-between px-6 border-b border-slate-200/70 shadow-sm supports-[backdrop-filter]:bg-white/60">
              <div class="flex items-center">
                  <button onclick="toggleSidebar()" class="mr-3 p-1.5 text-slate-500 hover:bg-slate-100 hover:text-slate-800 rounded-lg transition-colors focus:outline-none"><i class="fas fa-bars text-lg"></i></button>
                  <div><h2 id="pageTitle" class="text-lg font-bold text-slate-800 tracking-tight">Dashboard</h2></div>
              </div>
              <div class="flex items-center space-x-4">
                  <div class="text-right hidden md:block">
                      <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Hari ini</p>
                      <p class="text-xs font-bold text-slate-700" id="currentDateDisplay">Senin, 1 Jan 2026</p>
                  </div>
                  <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 relative cursor-pointer hover:bg-slate-50 hover:border-slate-300 transition shadow-sm">
                      <i class="far fa-bell text-xs"></i>
                      <span class="absolute top-2 right-2 w-1.5 h-1.5 bg-rose-500 rounded-full ring-1 ring-white"></span>
                  </div>
              </div>
          </header>

          <div id="mainContentArea" class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 scroll-smooth">
              
<div id="view-admin-dashboard" class="view-section animate-fade-in">
                  
                  <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                      <div>
                           <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Dashboard Admin</h2>
                           <p class="text-sm text-gray-500 mt-1">Pusat kontrol data absensi sekolah.</p>
                      </div>
                      <div class="flex items-center gap-3">
                          <span class="text-xs font-bold bg-white text-gray-600 px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                              <i class="far fa-clock mr-2"></i> <span id="adminDateDisplay">...</span>
                          </span>
                          <button onclick="refreshData('dashboard')" class="flex items-center space-x-2 text-xs font-bold text-white bg-indigo-600 border border-indigo-600 px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition transform active:scale-95">
                              <i class="fas fa-sync-alt"></i> <span>Refresh Data</span>
                          </button>
                      </div>
                  </div>

                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                      
                      <div class="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 flex flex-col justify-between relative overflow-hidden group">
                          <div class="absolute right-0 top-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Total Siswa</p>
                          <div class="flex items-center justify-between mt-2 relative z-10">
                              <h3 id="admStatTotal" class="text-2xl font-bold text-gray-800">-</h3>
                              <div class="text-indigo-500 bg-indigo-50 p-2 rounded-lg"><i class="fas fa-users"></i></div>
                          </div>
                      </div>

                      <div class="bg-white p-5 rounded-xl shadow-sm border border-emerald-100 flex flex-col justify-between relative overflow-hidden group">
                          <div class="absolute right-0 top-0 w-16 h-16 bg-emerald-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Hadir</p>
                          <div class="flex items-center justify-between mt-2 relative z-10">
                              <h3 id="admStatHadir" class="text-2xl font-bold text-gray-800">-</h3>
                              <div class="text-emerald-500 bg-emerald-50 p-2 rounded-lg"><i class="fas fa-check"></i></div>
                          </div>
                      </div>

                      <div class="bg-white p-5 rounded-xl shadow-sm border border-yellow-100 flex flex-col justify-between relative overflow-hidden group">
                          <div class="absolute right-0 top-0 w-16 h-16 bg-yellow-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Sakit</p>
                          <div class="flex items-center justify-between mt-2 relative z-10">
                              <h3 id="admStatSakit" class="text-2xl font-bold text-gray-800">-</h3>
                              <div class="text-yellow-500 bg-yellow-50 p-2 rounded-lg"><i class="fas fa-procedures"></i></div>
                          </div>
                      </div>

                      <div class="bg-white p-5 rounded-xl shadow-sm border border-blue-100 flex flex-col justify-between relative overflow-hidden group">
                          <div class="absolute right-0 top-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Izin</p>
                          <div class="flex items-center justify-between mt-2 relative z-10">
                              <h3 id="admStatIzin" class="text-2xl font-bold text-gray-800">-</h3>
                              <div class="text-blue-500 bg-blue-50 p-2 rounded-lg"><i class="fas fa-paper-plane"></i></div>
                          </div>
                      </div>

                      <div class="bg-white p-5 rounded-xl shadow-sm border border-red-100 flex flex-col justify-between relative overflow-hidden group">
                          <div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest relative z-10">Alpa</p>
                          <div class="flex items-center justify-between mt-2 relative z-10">
                              <h3 id="admStatAlpa" class="text-2xl font-bold text-gray-800">-</h3>
                              <div class="text-red-500 bg-red-50 p-2 rounded-lg"><i class="fas fa-times"></i></div>
                          </div>
                      </div>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      
                      <div class="lg:col-span-2 bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                          <div class="flex justify-between items-center mb-6">
                              <h3 class="text-sm font-bold text-gray-700 flex items-center">
                                  <i class="fas fa-chart-bar text-indigo-500 mr-2"></i> Grafik Statistik Kehadiran
                              </h3>
                          </div>
                          <div class="relative w-full h-[350px]">
                               <canvas id="adminAttendanceChart"></canvas>
                          </div>
                      </div>

                      <div class="flex flex-col gap-4">
                        <div id="adminQuickAccess" class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm h-full">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center text-sm">
                                <i class="fas fa-bolt text-amber-500 mr-2"></i> Akses Cepat
                            </h3>
                              <div class="space-y-3">
                                  <button onclick="loadScanAbsensi()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-indigo-50 hover:border-indigo-200 transition-all group text-left">
                                      <div class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-qrcode"></i></div>
                                      <div>
                                          <div class="font-bold text-xs text-gray-700">Scan Absensi</div>
                                          <div class="text-[10px] text-gray-400">Mode scanner kamera</div>
                                      </div>
                                  </button>
                                  
                                  <button onclick="loadDataSiswa()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-blue-50 hover:border-blue-200 transition-all group text-left">
                                      <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-user-graduate"></i></div>
                                      <div>
                                          <div class="font-bold text-xs text-gray-700">Data Siswa</div>
                                          <div class="text-[10px] text-gray-400">Kelola database siswa</div>
                                      </div>
                                  </button>

                                  <button onclick="loadRekapAbsensi()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-emerald-50 hover:border-emerald-200 transition-all group text-left">
                                      <div class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-file-alt"></i></div>
                                      <div>
                                          <div class="font-bold text-xs text-gray-700">Laporan</div>
                                          <div class="text-[10px] text-gray-400">Export & rekap data</div>
                                      </div>
                                  </button>
                                  
                                  <button onclick="loadKelolaAbsen()" class="w-full flex items-center p-3 rounded-xl border border-gray-100 hover:bg-rose-50 hover:border-rose-200 transition-all group text-left">
                                      <div class="w-10 h-10 rounded-lg bg-rose-100 text-rose-600 flex items-center justify-center mr-3 group-hover:scale-110 transition"><i class="fas fa-calendar-times"></i></div>
                                      <div>
                                          <div class="font-bold text-xs text-gray-700">Hari Libur</div>
                                          <div class="text-[10px] text-gray-400">Setting tanggal merah</div>
                                      </div>
                                  </button>
                              </div>
                          </div>
                      </div>

                  </div>
              </div>

<div id="view-guru-dashboard" class="view-section animate-fade-in">
                  
                  <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                      <div>
                           <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Dashboard Guru</h2>
                           <p class="text-sm text-gray-500 mt-1">Ringkasan aktivitas siswa hari ini.</p>
                      </div>
                      <div class="flex items-center gap-3">
                          <span class="text-xs font-bold bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg border border-indigo-100">
                              <i class="far fa-calendar-alt mr-2"></i> <span id="guruDashboardDate">...</span>
                          </span>
                          <button onclick="refreshData('dashboard')" class="flex items-center space-x-2 text-xs font-bold text-gray-600 bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 transition">
                              <i class="fas fa-sync-alt"></i> <span>Refresh</span>
                          </button>
                      </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                      
                      <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 group hover:shadow-md transition-all">
                          <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                          <div class="relative z-10 flex flex-col h-full justify-between">
                              <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm">
                                  <i class="fas fa-user-graduate"></i>
                              </div>
                              <div>
                                  <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Siswa</p>
                                  <h3 id="statGuruTotal" class="text-3xl font-bold text-gray-800 mt-1">-</h3>
                              </div>
                          </div>
                      </div>

                      <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 group hover:shadow-md transition-all">
                          <div class="absolute top-0 right-0 w-24 h-24 bg-yellow-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                          <div class="relative z-10 flex flex-col h-full justify-between">
                              <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm">
                                  <i class="fas fa-procedures"></i>
                              </div>
                              <div>
                                  <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Sakit</p>
                                  <h3 id="statGuruSakit" class="text-3xl font-bold text-gray-800 mt-1">-</h3>
                              </div>
                          </div>
                      </div>

                      <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-blue-100 group hover:shadow-md transition-all">
                          <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                          <div class="relative z-10 flex flex-col h-full justify-between">
                              <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm">
                                  <i class="fas fa-envelope-open-text"></i>
                              </div>
                              <div>
                                  <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Izin</p>
                                  <h3 id="statGuruIzin" class="text-3xl font-bold text-gray-800 mt-1">-</h3>
                              </div>
                          </div>
                      </div>

                      <div class="relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-red-100 group hover:shadow-md transition-all">
                          <div class="absolute top-0 right-0 w-24 h-24 bg-red-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                          <div class="relative z-10 flex flex-col h-full justify-between">
                              <div class="w-12 h-12 bg-red-100 text-red-600 rounded-xl flex items-center justify-center text-xl mb-4 shadow-sm">
                                  <i class="fas fa-times-circle"></i>
                              </div>
                              <div>
                                  <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Alpa</p>
                                  <h3 id="statGuruAlpa" class="text-3xl font-bold text-gray-800 mt-1">-</h3>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      <div class="lg:col-span-2 bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                          <h3 class="text-sm font-bold text-gray-700 mb-6 flex items-center justify-between">
                              <span><i class="fas fa-chart-bar text-indigo-500 mr-2"></i> Statistik Kehadiran Hari Ini</span>
                              <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">Realtime</span>
                          </h3>
                          <div class="relative w-full h-[300px]">
                              <canvas id="guruAttendanceChart"></canvas>
                          </div>
                      </div>

                      <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden flex flex-col justify-center items-center text-center">
                          <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                          <div class="relative z-10">
                              <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-2xl mb-4 mx-auto border border-white/20">
                                  <i class="fas fa-qrcode"></i>
                              </div>
                              <h3 class="text-lg font-bold mb-2">Mulai Absensi</h3>
                              <p class="text-indigo-100 text-xs mb-6 px-4">Buka pemindai kamera untuk melakukan absensi siswa secara cepat.</p>
                              <button onclick="loadScanAbsensi()" class="bg-white text-indigo-700 px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-gray-50 transition transform active:scale-95 w-full">
                                  Buka Scanner
                              </button>
                          </div>
                      </div>
                  </div>
              </div>

<div id="view-siswa-dashboard" class="view-section animate-fade-in h-full">
                <div class="flex justify-end mb-4">
                    <button onclick="refreshData('dashboard')" class="flex items-center space-x-2 text-xs font-bold text-indigo-600 bg-white border border-indigo-100 px-3 py-1.5 rounded-lg shadow-sm hover:bg-indigo-50 transition">
                        <i class="fas fa-sync-alt"></i> <span>Refresh</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
                    
                    <div class="lg:col-span-2 space-y-6">
                        
                        <div id="heroCard" class="relative overflow-hidden rounded-3xl bg-slate-800 p-6 text-white shadow-xl shadow-slate-200 transition-all duration-500 group">
                            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl transition-transform duration-700 group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <p id="dashDate" class="text-slate-300 text-[10px] font-bold tracking-widest uppercase mb-1">...</p>
                                        <h2 class="text-3xl font-bold tracking-tight mb-1">Hai, <span id="dashGreeting">Siswa</span></h2>
                                        <p class="text-slate-400 text-xs">Semoga harimu menyenangkan!</p>
                                    </div>
                                    <div id="dashStatusBadge" class="px-4 py-2 rounded-xl bg-white/10 backdrop-blur-md border border-white/10 text-white text-xs font-bold shadow-sm">
                                        Memuat...
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                    <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10">
                                        <div class="flex items-center gap-2 mb-2 text-slate-300">
                                            <i class="fas fa-sign-in-alt text-xs"></i>
                                            <span class="text-[10px] uppercase font-bold tracking-wider">Jam Datang</span>
                                        </div>
                                        <div id="valMasuk" class="font-mono text-2xl font-bold tracking-tight">--:--</div>
                                    </div>
                                    <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-4 border border-white/10">
                                        <div class="flex items-center gap-2 mb-2 text-slate-300">
                                            <i class="fas fa-sign-out-alt text-xs"></i>
                                            <span class="text-[10px] uppercase font-bold tracking-wider">Jam Pulang</span>
                                        </div>
                                        <div id="valPulang" class="font-mono text-2xl font-bold tracking-tight">--:--</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="alertBelumAbsen" class="hidden bg-rose-50 border border-rose-100 rounded-xl p-4 flex gap-3 items-start shadow-sm">
                            <div class="bg-white p-2 rounded-full text-rose-500 shadow-sm"><i class="fas fa-exclamation"></i></div>
                            <div>
                                <h4 class="text-sm font-bold text-rose-800 mb-0.5">Peringatan Absensi</h4>
                                <p class="text-xs font-medium text-rose-600/80 leading-relaxed">
                                  Anda belum melakukan scan absensi datang hari ini. Harap segera lakukan absensi.
                                </p>
                            </div>
                        </div>
                    </div> 
                    
                    <div class="space-y-6">
                        
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                            <div class="relative z-10 -mt-2">
                                <div class="w-20 h-20 bg-white p-1 rounded-full mx-auto shadow-md">
                                    <div class="w-full h-full bg-slate-100 rounded-full flex items-center justify-center text-3xl text-slate-300">
                                      <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <h3 id="profileNameSidebar" class="font-bold text-slate-800 text-lg mt-3 truncate">Nama Siswa</h3>
                                <p id="profileNisnSidebar" class="text-xs font-mono text-slate-500 bg-slate-100 inline-block px-2 py-1 rounded mt-1">1234567890</p>
                                
                                <div class="grid grid-cols-2 gap-2 mt-4 text-left">
                                    <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                        <p class="text-[10px] text-slate-400 uppercase font-bold">Kelas</p>
                                        <p id="profileKelasSidebar" class="text-sm font-bold text-slate-700">-</p>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                        <p class="text-[10px] text-slate-400 uppercase font-bold">Status</p>
                                        <p class="text-sm font-bold text-emerald-600">Aktif</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onclick="loadQRCodeSiswa()" class="w-full group relative overflow-hidden rounded-2xl bg-slate-900 p-1 shadow-lg shadow-slate-900/10 transition-all active:scale-[0.98]">
                            <div class="relative bg-slate-900 rounded-[0.9rem] px-5 py-4 flex items-center justify-between transition-all group-hover:bg-slate-800">
                                <div class="text-left">
                                    <h3 class="text-white font-bold text-sm">Kartu Digital</h3>
                                    <p class="text-slate-400 text-[10px]">Tampilkan QR Code</p>
                                </div>
                                <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-white text-lg">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                            </div>
                        </button>

                    </div> 
                </div> 
              </div>
<div id="view-data-siswa" class="view-section animate-fade-in">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      
      <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/30">
        <div>
            <h3 class="font-bold text-sm text-gray-800">Direktori Siswa</h3>
            <p class="text-xs text-gray-500">Kelola data siswa, kelas, dan cetak kartu.</p>
        </div>
        
        <div class="flex items-center gap-2 flex-wrap justify-end">
            <button onclick="refreshData('siswa')" class="bg-white text-gray-600 border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 hover:text-indigo-600 transition" title="Perbarui Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <button onclick="downloadTemplate('siswa')" class="bg-amber-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-amber-600 transition transform active:scale-95" title="Download Template Excel">
                <i class="fas fa-download mr-1"></i> Template
            </button>

            <button onclick="downloadKartuSiswaBulk()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-indigo-700 transition transform active:scale-95">
                <i class="fas fa-id-card mr-1"></i> Cetak Kartu
            </button>

            <button onclick="triggerImportSiswa()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-emerald-700 transition transform active:scale-95">
                <i class="fas fa-file-excel mr-1"></i> Import Excel
            </button>
            <input type="file" id="fileInputSiswa" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileImportSiswa(this)">

            <button onclick="showAddSiswaModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-blue-700 transition transform active:scale-95">
                <i class="fas fa-plus mr-1"></i> Tambah
            </button>
        </div>
      </div>

      <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
          
          <div class="flex flex-col sm:flex-row items-center gap-3 text-xs w-full md:w-auto">
              <div class="flex items-center gap-2 w-full sm:w-auto">
                  <span class="text-gray-500 font-bold whitespace-nowrap">Show</span>
                  <select onchange="handleTableLimit('siswa', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full sm:w-auto cursor-pointer">
                      <option value="10">10</option>
                      <option value="25">25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                      <option value="all">Semua</option>
                  </select>
              </div>

              <select id="filterKelasSiswa" onchange="handleTableClassFilter('siswa', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full sm:w-40 font-bold shadow-sm cursor-pointer">
                    <option value="">Semua Kelas</option>
              </select>
          </div>

          <div class="relative w-full md:w-64">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-gray-400 text-xs"></i>
              </div>
              <input type="text" oninput="handleTableSearch('siswa', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2 transition-all" placeholder="Cari Nama / NISN...">
          </div>
      </div>

      <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
              <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold border-b border-gray-200">
                  <tr>
                      <th class="p-3 text-center w-12">No</th>
                      <th class="p-3">Nama Lengkap</th>
                      <th class="p-3 hidden md:table-cell">NISN</th>
                      <th class="p-3 hidden sm:table-cell">Kelas</th>
                      <th class="p-3 text-center w-40">Aksi</th>
                  </tr>
              </thead>
              <tbody id="tbody-siswa" class="divide-y divide-gray-50 bg-white text-xs text-gray-700">
                  </tbody>
          </table>
      </div>

      <div id="footer-siswa" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500">
          <span id="info-siswa">Menampilkan 0 data</span>
          <div class="flex gap-1">
              <button onclick="changePage('siswa', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition shadow-sm" id="btn-prev-siswa">Prev</button>
              <button onclick="changePage('siswa', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition shadow-sm" id="btn-next-siswa">Next</button>
          </div>
      </div>
  </div>
</div>

<div id="view-data-guru" class="view-section animate-fade-in">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/30">
          <div>
              <h3 class="font-bold text-sm text-gray-800">Manajemen Guru</h3>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="refreshData('guru')" class="bg-white text-gray-600 border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 hover:text-purple-600 transition" title="Perbarui Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <button onclick="downloadTemplate('guru')" class="bg-amber-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-amber-600 transition transform active:scale-95" title="Download Template Excel">
                <i class="fas fa-download mr-1"></i> Template
            </button>

            <button onclick="triggerImportGuru()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-emerald-700 transition">
                <i class="fas fa-file-excel mr-1"></i> Import Excel
            </button>
            <input type="file" id="fileInputGuru" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileImportGuru(this)">
          
            <button onclick="showAddGuruModal()" class="bg-purple-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-purple-700 transition">
                <i class="fas fa-plus mr-1"></i> Tambah
            </button>
          </div>
      </div>

      <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
          
          <div class="flex flex-col sm:flex-row items-center gap-3 text-xs w-full md:w-auto">
              <div class="flex items-center gap-2">
                  <span class="text-gray-500 font-bold">Show</span>
                  <select onchange="handleTableLimit('guru', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2">
                      <option value="10">10</option>
                      <option value="25">25</option>
                      <option value="50">50</option>
                      <option value="all">Semua</option>
                  </select>
              </div>

              <select id="filterKelasGuru" onchange="handleTableClassFilter('guru', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2 w-full sm:w-40 font-bold shadow-sm">
                    <option value="">Semua Kelas</option>
              </select>
          </div>

          <div class="relative w-full md:w-64">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-gray-400 text-xs"></i>
              </div>
              <input type="text" oninput="handleTableSearch('guru', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full pl-10 p-2" placeholder="Cari Username...">
          </div>
      </div>

      <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold">
                <tr>
                    <th class="p-3 text-center w-10">No</th>
                    <th class="p-3">Username</th>
                    <th class="p-3">Wali Kelas</th>
                    <th class="p-3">Password</th>
                    <th class="p-3 text-center">Aksi</th>
                </tr>
            </thead>
              <tbody id="tbody-guru" class="divide-y divide-gray-50 bg-white text-xs">
                  </tbody>
          </table>
      </div>

      <div id="footer-guru" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500">
          <span id="info-guru">Menampilkan 0 data</span>
          <div class="flex gap-1">
              <button onclick="changePage('guru', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-prev-guru">Prev</button>
              <button onclick="changePage('guru', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-next-guru">Next</button>
          </div>
      </div>
  </div>
</div>

<div id="view-kelola-absen" class="view-section animate-fade-in">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-24">
              <div class="p-5 border-b border-gray-100 bg-indigo-50/50">
                  <h3 class="font-bold text-gray-800 flex items-center">
                      <i class="fas fa-clock text-indigo-600 mr-2"></i> Pengaturan Waktu
                  </h3>
                  <p class="text-xs text-gray-500 mt-1">Konfigurasi jam operasional absensi.</p>
              </div>
              <div class="p-5">
                  <form onsubmit="saveGlobalConfig(event)">
                      <div class="space-y-4">
                          <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                              <p class="text-[10px] uppercase font-bold text-gray-400 mb-2">Absen Datang</p>
                              <div class="grid grid-cols-2 gap-3">
                                  <div>
                                      <label class="block text-xs font-bold text-gray-700 mb-1">Mulai Buka</label>
                                      <input type="time" id="conf_masuk_mulai" name="jam_masuk_mulai" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                  </div>
                                  <div>
                                      <label class="block text-xs font-bold text-gray-700 mb-1">Batas Terlambat</label>
                                      <input type="time" id="conf_masuk_akhir" name="jam_masuk_akhir" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                  </div>
                              </div>
                              <p class="text-[10px] text-orange-500 mt-1.5"><i class="fas fa-info-circle"></i> Lewat batas ini status: <b>Terlambat</b></p>
                          </div>

                          <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                              <p class="text-[10px] uppercase font-bold text-gray-400 mb-2">Absen Pulang</p>
                              <div class="grid grid-cols-2 gap-3">
                                  <div>
                                      <label class="block text-xs font-bold text-gray-700 mb-1">Mulai Buka</label>
                                      <input type="time" id="conf_pulang_mulai" name="jam_pulang_mulai" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                  </div>
                                  <div>
                                      <label class="block text-xs font-bold text-gray-700 mb-1">Tutup Absen</label>
                                      <input type="time" id="conf_pulang_akhir" name="jam_pulang_akhir" required class="w-full border-gray-300 rounded-lg text-xs p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                  </div>
                              </div>
                              <p class="text-[10px] text-orange-500 mt-1.5"><i class="fas fa-info-circle"></i> Pulang sebelum dibuka: <b>Pulang Cepat</b></p>
                          </div>
                      </div>
                      
                      <button type="submit" id="btnSaveConfig" class="w-full mt-5 bg-indigo-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 transition transform active:scale-95 flex items-center justify-center gap-2">
                          <i class="fas fa-save"></i> Simpan Pengaturan
                      </button>
                  </form>
              </div>
          </div>
      </div>

      <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-5 border-b border-gray-100 bg-gray-50/30 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-gray-800">Daftar Hari Libur</h3>
                    <p class="text-xs text-gray-500 mt-1">Siswa tidak bisa absen pada tanggal ini.</p>
                </div>
                <div>
                    <button onclick="triggerImportLibur()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-emerald-700 transition">
                        <i class="fas fa-file-excel mr-1"></i> Import Excel
                    </button>
                    <input type="file" id="fileInputLibur" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileImportLibur(this)">
                </div>
            </div>

              <div class="p-5 border-b border-gray-100">
                  <form onsubmit="handleAddLibur(event)" class="flex flex-col md:flex-row gap-3 items-end">
                      <div class="flex-1 w-full">
                          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tanggal</label>
                          <input type="date" name="tanggal" required class="w-full border-gray-300 rounded-lg text-sm p-2.5">
                      </div>
                      <div class="flex-[2] w-full">
                          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Keterangan</label>
                          <input type="text" name="keterangan" required placeholder="Contoh: Maulid Nabi / Cuti Bersama" class="w-full border-gray-300 rounded-lg text-sm p-2.5">
                      </div>
                      <button type="submit" class="bg-emerald-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-emerald-700 transition w-full md:w-auto">
                          <i class="fas fa-plus mr-1"></i> Tambah
                      </button>
                  </form>
              </div>

              <div class="overflow-x-auto">
                  <table class="w-full text-left">
                      <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold">
                          <tr>
                              <th class="p-4 w-10 text-center">No</th>
                              <th class="p-4">Tanggal</th>
                              <th class="p-4">Keterangan</th>
                              <th class="p-4 text-center w-20">Aksi</th>
                          </tr>
                      </thead>
                      <tbody id="tbody-libur" class="divide-y divide-gray-50 text-sm"></tbody>
                  </table>
              </div>

              <div id="footer-libur" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500">
                  <span id="info-libur">Menampilkan 0 data</span>
                  <div class="flex gap-1">
                      <button onclick="changePage('libur', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-prev-libur">Prev</button>
                      <button onclick="changePage('libur', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-next-libur">Next</button>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>

<div id="view-monitoring" class="view-section animate-fade-in">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center bg-gray-50/30 gap-4">
            <div>
                <h3 class="font-bold text-sm text-gray-800 mb-1">Monitoring Kehadiran</h3>
                <p class="text-xs text-gray-500 font-medium">Data Realtime: <span id="monitoringDate" class="text-indigo-600 font-bold">...</span></p>
            </div>
            
            <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm w-full md:w-auto justify-center">
                    <input type="date" id="exportMonStart" class="text-xs border-none focus:ring-0 text-gray-600 font-bold p-1 rounded bg-transparent cursor-pointer" title="Tanggal Mulai">
                    <span class="text-gray-400 text-[10px]">-</span>
                    <input type="date" id="exportMonEnd" class="text-xs border-none focus:ring-0 text-gray-600 font-bold p-1 rounded bg-transparent cursor-pointer" title="Tanggal Akhir">
                </div>

                <button onclick="exportMonitoringExcel()" id="btnExportMonitoring" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-emerald-700 transition transform active:scale-95 flex items-center gap-2 w-full md:w-auto justify-center">
                    <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Export Excel</span>
                </button>

                <button onclick="refreshData('monitoring')" class="bg-white text-gray-600 border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 hover:text-indigo-600 transition w-full md:w-auto" title="Perbarui Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex flex-col sm:flex-row items-center gap-2 text-xs w-full md:w-auto">
                
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <span class="text-gray-500 font-bold hidden sm:inline">Show</span>
                    <select onchange="handleTableLimit('monitoring', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full sm:w-auto cursor-pointer">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="all">Semua</option>
                    </select>
                </div>

                <select onchange="handleTableStatusFilter('monitoring', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 font-bold w-full sm:w-auto shadow-sm cursor-pointer">
                    <option value="">Semua Status</option>
                    <option value="Hadir">Hadir (Hijau)</option>
                    <option value="Sakit">Sakit (Kuning)</option>
                    <option value="Izin">Izin (Biru)</option>
                    <option value="Alpa">Alpa (Merah)</option>
                    <option value="Belum Absen">Belum Absen (Abu)</option>
                </select>
            </div>

            <div class="relative w-full md:w-64">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400 text-xs"></i>
                </div>
                <input type="text" oninput="handleTableSearch('monitoring', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2 transition-all" placeholder="Cari Nama / Kelas...">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold">
                  <tr>
                      <th class="p-4 text-center w-10">No</th>
                      <th class="p-4">Siswa</th>
                      <th class="p-4 text-center">Kelas</th>
                      <th class="p-4 text-center">Jam Datang</th>
                      <th class="p-4 text-center">Jam Pulang</th>
                      <th class="p-4 text-center">Keterangan Waktu</th>
                      <th class="p-4 text-center">Status Kehadiran</th>
                  </tr>
              </thead>
              <tbody id="tbody-monitoring" class="divide-y divide-gray-50 bg-white text-sm">
                  </tbody>
            </table>
        </div>

        <div id="footer-monitoring" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500">
            <span id="info-monitoring">Menampilkan 0 data</span>
            <div class="flex gap-1">
                <button onclick="changePage('monitoring', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-prev-monitoring">Prev</button>
                <button onclick="changePage('monitoring', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50 transition" id="btn-next-monitoring">Next</button>
            </div>
        </div>
    </div>
</div>


<div id="view-rekap-bulanan" class="view-section animate-fade-in hidden">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-indigo-50/30">
            <div>
                <h3 class="font-bold text-gray-800">Rekapitulasi Bulanan</h3>
                <p class="text-xs text-gray-500">Matriks kehadiran siswa per bulan</p>
            </div>

            <div class="flex flex-wrap items-center gap-2 justify-end w-full md:w-auto">
                <select id="rekapKelas" class="bg-white border border-gray-200 text-gray-700 text-xs rounded-lg p-2 font-bold focus:ring-indigo-500 shadow-sm cursor-pointer w-full md:w-auto">
                    <option value="">Semua Kelas</option>
                </select>

                <select id="rekapBulan" class="bg-white border border-gray-200 text-gray-700 text-xs rounded-lg p-2 font-bold focus:ring-indigo-500 shadow-sm cursor-pointer w-1/2 md:w-auto">
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                </select>

                <select id="rekapTahun" class="bg-white border border-gray-200 text-gray-700 text-xs rounded-lg p-2 font-bold focus:ring-indigo-500 shadow-sm cursor-pointer w-1/3 md:w-auto">
                    </select>

                <button onclick="loadDataRekapBulanan()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition shadow-sm flex items-center gap-2">
                    <i class="fas fa-search"></i> <span class="hidden sm:inline">Tampilkan</span>
                </button>

                <button onclick="exportRekapBulananExcel()" id="btnExportRekap" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition shadow-sm flex items-center gap-2">
                    <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Export</span>
                </button>
            </div>
        </div>

        <div class="overflow-x-auto relative">
            <table class="w-full text-left border-collapse text-xs">
                <thead class="bg-gray-100 text-gray-600 uppercase font-bold sticky top-0 z-10">
                    <tr id="thead-rekap-bulanan">
                        </tr>
                </thead>
                <tbody id="tbody-rekap-bulanan" class="divide-y divide-gray-100 bg-white">
                    <tr><td class="p-8 text-center text-gray-500" colspan="10">Silakan pilih filter dan klik Tampilkan.</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="p-3 bg-gray-50 border-t border-gray-100 flex flex-wrap gap-4 text-[10px] font-bold text-gray-500 justify-center">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> H: Hadir</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> S: Sakit</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> I: Izin</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> A: Alpha</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-red-100 border border-red-200"></span> Libur</span>
        </div>

        <div class="p-4 bg-indigo-50 border-t border-indigo-100 text-xs text-indigo-900">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <h4 class="font-bold mb-2 flex items-center gap-2 text-indigo-700">
                        <i class="fas fa-calculator"></i> Rumus Persentase
                    </h4>
                    <div class="bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                        <code class="font-mono text-indigo-600 font-bold text-sm block text-center mb-1">
                            (Jumlah Hadir / Hari Efektif) × 100%
                        </code>
                        <p class="text-[10px] text-center text-gray-400">Contoh: (1 Hadir / 10 Hari Efektif) × 100 = 10%</p>
                    </div>
                </div>

                <div class="flex-[2]">
                    <h4 class="font-bold mb-2 flex items-center gap-2 text-indigo-700">
                        <i class="fas fa-info-circle"></i> Penjelasan Istilah
                    </h4>
                    <ul class="space-y-1.5 text-gray-600">
                        <li class="flex gap-2">
                            <span class="font-bold text-indigo-600 w-24 shrink-0">Hari Efektif :</span>
                            <span>Jumlah total hari dalam bulan berjalan yang <b>sudah berlalu</b> dikurangi Hari Minggu dan Hari Libur Nasional. Hari masa depan (besok dst) tidak dihitung.</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="font-bold text-indigo-600 w-24 shrink-0">Status Alpha :</span>
                            <span>Siswa dianggap Alpha jika hari tersebut adalah <b>Hari Efektif</b> (sekolah masuk) namun siswa tidak melakukan scan kehadiran.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    </div>
</div>


<div id="view-kenaikan-kelas" class="view-section animate-fade-in hidden">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-indigo-900"><i class="fas fa-level-up-alt mr-2"></i>Proses Kenaikan Kelas</h3>
                <p class="text-xs text-indigo-600">Pilih kelas asal dan tujuan, lalu tentukan siswa yang naik/tinggal.</p>
            </div>
            <button onclick="showModalArsip()" class="bg-emerald-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-emerald-700 transition">
                <i class="fas fa-archive mr-1"></i> Tutup Tahun (Arsip)
            </button>
        </div>

        <div class="p-4">
            <div class="flex flex-col md:flex-row gap-4 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-700 mb-1">Kelas Asal (Sekarang)</label>
                    <select id="promoKelasAsal" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 font-bold text-gray-700">
                        <option value="">-- Pilih Kelas --</option>
                        </select>
                </div>
                
                <div class="flex items-center justify-center pt-4">
                    <i class="fas fa-arrow-right text-gray-400"></i>
                </div>

                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-700 mb-1">Naik Ke Kelas (Tujuan)</label>
                    <select id="promoKelasTujuan" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 font-bold text-indigo-700">
                        <option value="">-- Pilih Tujuan --</option>
                        <option value="LULUS" class="font-bold text-green-600">🎓 LULUS (Alumni)</option>
                        </select>
                </div>

                <div class="flex items-end">
                    <button onclick="loadSiswaUntukPromosi()" class="w-full md:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-md h-[38px]">
                        <i class="fas fa-users mr-2"></i> Load Siswa
                    </button>
                </div>
            </div>

            <div id="container-promo-siswa" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-sm text-gray-700">Daftar Siswa</h4>
                    <div class="text-xs space-x-2">
                        <span class="inline-flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-1"></span> Naik/Lulus</span>
                        <span class="inline-flex items-center"><span class="w-2 h-2 rounded-full bg-red-500 mr-1"></span> Tinggal Kelas</span>
                    </div>
                </div>

                <div class="overflow-x-auto border border-gray-200 rounded-lg max-h-[400px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 font-bold sticky top-0 z-10">
                            <tr>
                                <th class="p-3 w-10 text-center">No</th>
                                <th class="p-3">Nama Siswa</th>
                                <th class="p-3">NISN</th>
                                <th class="p-3 text-center">Status Keputusan</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-promo-siswa" class="divide-y divide-gray-100 bg-white">
                            </tbody>
                    </table>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800 mb-4 flex items-start gap-2">
                    <i class="fas fa-info-circle mt-0.5"></i>
                    <div>
                        <strong>Keterangan:</strong><br>
                        - Siswa dengan status <b>"Naik Kelas"</b> akan dipindahkan ke <b>Kelas Tujuan</b>.<br>
                        - Siswa dengan status <b>"Tinggal Kelas"</b> akan tetap berada di <b>Kelas Asal</b>.
                    </div>
                </div>

                <button onclick="executePromotion()" id="btn-eksekusi-promo" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg text-sm">
                    <i class="fas fa-check-double mr-2"></i> Simpan & Proses Kenaikan Kelas
                </button>
            </div>
            
            <div id="promo-placeholder" class="text-center py-12 text-gray-400">
                <i class="fas fa-chalkboard-teacher text-4xl mb-3 opacity-30"></i>
                <p>Silakan pilih kelas asal dan tujuan untuk memulai.</p>
            </div>

        </div>
    </div>
</div>

<div id="view-rekap-absensi" class="view-section animate-fade-in">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        
        <div class="p-5 border-b border-gray-100 bg-gray-50/50">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">Laporan Kehadiran</h3>
                    <p class="text-xs text-gray-500">Rekap data absensi siswa berdasarkan periode.</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3 items-end bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                
                <div class="w-full md:flex-1">
                   <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Dari Tanggal</label>
                   <input type="date" id="fStart" class="w-full border-gray-300 rounded-lg text-xs p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="w-full md:flex-1">
                   <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Sampai Tanggal</label>
                   <input type="date" id="fEnd" class="w-full border-gray-300 rounded-lg text-xs p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="w-full md:flex-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 block">Filter Kelas</label>
                    <select id="fKelasRekap" class="w-full border-gray-300 rounded-lg text-xs p-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">Semua Kelas</option>
                        </select>
                </div>

                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="applyFilter()" class="flex-1 md:flex-none bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold text-xs shadow-md hover:bg-indigo-700 transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-search"></i> Cari Data
                    </button>
                    
                    <button onclick="exportToExcel()" id="btnExportExcel" class="flex-1 md:flex-none bg-emerald-600 text-white px-5 py-2.5 rounded-lg font-bold text-xs shadow-md hover:bg-emerald-700 transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                </div>
            </div>
        </div>

        <div id="rekapContainer" class="hidden">
            <div class="p-4 bg-white border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2 text-xs">
                    <span class="text-gray-500 font-bold">Tampilkan</span>
                    <select onchange="handleTableLimit('rekap', this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="all">Semua</option>
                    </select>
                </div>
                <div class="relative w-full md:w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400 text-xs"></i>
                    </div>
                    <input type="text" oninput="handleTableSearch('rekap', this.value)" class="bg-gray-50 border border-gray-200 text-gray-900 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2" placeholder="Cari Siswa / Kelas...">
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left">
                  <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-semibold">
                      <tr>
                          <th class="p-4 text-center w-10">No</th>
                          <th class="p-4">Tanggal</th>
                          <th class="p-4">Nama Siswa</th>
                          <th class="p-4 text-center">Kelas</th>
                          <th class="p-4 text-center">Jam Datang</th>
                          <th class="p-4 text-center">Jam Pulang</th>
                          
                          <th class="p-4 text-center">Keterangan Waktu</th>
                          
                          <th class="p-4 text-center">Status</th>
                      </tr>
                  </thead>
                    <tbody id="tbody-rekap" class="bg-white divide-y divide-gray-50 text-sm"></tbody>
                </table>
            </div>

            <div id="footer-rekap" class="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-between items-center text-xs text-gray-500">
                <span id="info-rekap">Menampilkan 0 data</span>
                <div class="flex gap-1">
                    <button onclick="changePage('rekap', -1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-prev-rekap">Prev</button>
                    <button onclick="changePage('rekap', 1)" class="px-3 py-1 bg-white border border-gray-200 rounded hover:bg-gray-100 disabled:opacity-50" id="btn-next-rekap">Next</button>
                </div>
            </div>
        </div>
        
        <div id="rekapEmptyState" class="text-center p-16 flex flex-col items-center justify-center">
            <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-200 mb-4 text-4xl">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h4 class="font-bold text-gray-800 text-lg">Menunggu Filter</h4>
            <p class="text-gray-500 text-sm mt-1 max-w-xs mx-auto">Silakan pilih rentang tanggal mulai dan akhir, lalu klik tombol <b>Cari Data</b>.</p>
        </div>
        
        <div id="rekapLoading" class="hidden text-center p-16 flex flex-col items-center justify-center">
             <div class="w-16 h-16 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
             <h4 class="font-bold text-gray-800">Sedang Memproses...</h4>
             <p class="text-gray-500 text-xs mt-1">Mengambil data dari server</p>
        </div>

    </div>
</div>
              <div id="view-scanner" class="view-section animate-fade-in">
                  <div class="max-w-xs mx-auto">
                      <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                          <div class="p-4 bg-gray-900 text-white text-center">
                              <h3 class="font-bold text-lg tracking-wide">Scanner</h3>
                          </div>
                          <div class="p-4">
                              <div class="relative w-full aspect-square bg-black rounded-xl overflow-hidden mb-4 shadow-inner">
                                  <div id="reader" class="w-full h-full object-cover"></div>
                                  <div id="camLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-20">
                                      <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-indigo-500"></i>
                                      <p class="text-xs font-medium text-white">Memuat...</p>
                                  </div>
                              </div>
                              <div id="scanResult" class="hidden mb-4 text-center text-xs font-bold animate-fade-in"></div>
                              <div class="flex gap-2 mb-2">
                                  <button onclick="startCamera('environment')" class="flex-1 bg-blue-50 text-blue-700 py-2 rounded-lg font-bold text-xs hover:bg-blue-100">Belakang</button>
                                  <button onclick="startCamera('user')" class="flex-1 bg-purple-50 text-purple-700 py-2 rounded-lg font-bold text-xs hover:bg-purple-100">Depan</button>
                              </div>
                              <button onclick="stopAndBack(true)" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-bold text-xs hover:bg-gray-200">Kembali</button>
                          </div>
                      </div>
                  </div>
              </div>

              <div id="view-kartu-siswa" class="view-section animate-fade-in">
                  <div id="kartuSiswaContainer"></div>
              </div>

          </div>
      </main>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-50 hidden flex items-center justify-center flex-col transition-opacity">
    <div class="p-5 bg-white rounded-2xl shadow-2xl flex flex-col items-center">
        <div class="w-10 h-10 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-3"></div>
        <p class="text-slate-800 text-xs font-bold tracking-wide">Memproses...</p>
    </div>
  </div>
  
  <div id="modalContainer"></div>
<script>
    // ==========================================================================
    // 1. GLOBAL STATE & KONFIGURASI
    // ==========================================================================
    let currentUser = null;
    let html5QrCode = null;
    let isScanning = false;
    let isSidebarOpen = true; 
    
    // --- SMART CACHE ---
    let appCache = {
        siswa: null,
        guru: null
    };

    // --- CHART & UTILS ---
    let dashboardChart = null;
    let existingClasses = []; // Untuk autocomplete kelas
    let guruChartInstance = null;
    let adminChartInstance = null;

    // Set Tanggal Hari Ini
    const dateElement = document.getElementById('currentDateDisplay');
    if (dateElement) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = new Date().toLocaleDateString('id-ID', options);
    }

    const tableState = {
                siswa: { fullData: [], filtered: [], limit: 10, page: 1, search: '', classFilter: '' },
                // UPDATE BAGIAN INI: Tambahkan classFilter: ''
                guru: { fullData: [], filtered: [], limit: 10, page: 1, search: '', classFilter: '' },
                
                libur: { fullData: [], filtered: [], limit: 10, page: 1, search: '' },
                rekap: { fullData: [], filtered: [], limit: 10, page: 1, search: '' },
                monitoring: { fullData: [], filtered: [], limit: 10, page: 1, search: '', statusFilter: '' }
            };

function handleTableSearch(type, query) {
        tableState[type].search = query.toLowerCase();
        tableState[type].page = 1; // Reset ke halaman 1 saat search
        processTableData(type);
    }

// FUNGSI BARU: Handle perubahan dropdown filter kelas
    function handleTableClassFilter(type, value) {
        if (tableState[type]) {
            tableState[type].classFilter = value;
            tableState[type].page = 1; // Reset ke halaman 1
            processTableData(type);
        }
    }
    
function handleTableStatusFilter(type, status) {
        if (tableState[type]) {
            tableState[type].statusFilter = status;
            tableState[type].page = 1; // Reset ke halaman 1
            processTableData(type);
        }
    }

    function handleTableLimit(type, limit) {
        tableState[type].limit = limit === 'all' ? Infinity : parseInt(limit);
        tableState[type].page = 1; // Reset ke halaman 1 saat ganti limit
        processTableData(type);
    }

    function changePage(type, direction) {
        const state = tableState[type];
        const maxPage = Math.ceil(state.filtered.length / state.limit);
        const newPage = state.page + direction;
        
        if (newPage >= 1 && newPage <= maxPage) {
            state.page = newPage;
            processTableData(type);
        }
    }

function processTableData(type) {
        const state = tableState[type];
        
        // 1. Mulai dari data mentah (Full Data)
        let result = [...state.fullData];

        // 2. FILTER KHUSUS: KELAS (Untuk Siswa & Guru)
        // Logika ini akan jalan jika dropdown filter kelas dipilih
        if ((type === 'siswa' || type === 'guru') && state.classFilter) {
            result = result.filter(item => item.kelas === state.classFilter);
        }

        // 3. FILTER KHUSUS: STATUS KEHADIRAN (Untuk Monitoring)
        if (type === 'monitoring' && state.statusFilter) {
            result = result.filter(item => item.status === state.statusFilter);
        }

        // 4. FILTER UMUM: PENCARIAN (SEARCH)
        if (state.search) {
            const query = state.search.toLowerCase();
            result = result.filter(item => 
                Object.values(item).some(val => 
                    String(val).toLowerCase().includes(query)
                )
            );
        }

        // 5. Simpan hasil penyaringan ke state
        state.filtered = result;

        // 6. LOGIKA PAGINASI
        const total = state.filtered.length;
        const totalPages = Math.ceil(total / state.limit);
        
        // Koreksi halaman jika melebihi total halaman (misal setelah search/filter)
        if (state.page > totalPages && totalPages > 0) state.page = totalPages;
        if (total === 0) state.page = 1;

        const startIdx = (state.page - 1) * state.limit;
        const endIdx = startIdx + state.limit;
        
        // Ambil data untuk halaman saat ini
        const pagedData = state.filtered.slice(startIdx, endIdx);

        // 7. RENDER TABEL (Pilih renderer berdasarkan tipe)
        if (type === 'siswa') renderSiswaRows(pagedData, startIdx);
        else if (type === 'guru') renderGuruRows(pagedData, startIdx);
        else if (type === 'libur') renderLiburRows(pagedData, startIdx);
        else if (type === 'rekap') renderRekapRows(pagedData);
        else if (type === 'monitoring') renderMonitoringRows(pagedData, startIdx);

        // 8. UPDATE UI PAGINATION (Footer Tabel)
        updatePaginationUI(type, startIdx, pagedData.length, total, state.page, totalPages);
    }

    function updatePaginationUI(type, startIdx, currentCount, total, currentPage, totalPages) {
        const infoEl = document.getElementById(`info-${type}`);
        const btnPrev = document.getElementById(`btn-prev-${type}`);
        const btnNext = document.getElementById(`btn-next-${type}`);
        
        if (total === 0) {
            infoEl.textContent = 'Tidak ada data ditemukan.';
            btnPrev.disabled = true;
            btnNext.disabled = true;
        } else {
            const end = startIdx + currentCount;
            infoEl.textContent = `Menampilkan ${startIdx + 1} - ${end} dari ${total} data`;
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage >= totalPages;
        }
    }
    // ==========================================================================
    // 2. SESSION MANAGEMENT
    // ==========================================================================
    function checkSession() {
        const storedSession = localStorage.getItem('absensiAppSession');
        if (storedSession) {
            try {
                const sessionData = JSON.parse(storedSession);
                if (sessionData && sessionData.success) {
                    currentUser = sessionData;
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboardContainer').classList.remove('hidden');
                    
                    if (window.innerWidth < 768) {
                         document.getElementById('sidebar').classList.add('-translate-x-full');
                    }
                    
                    initDashboard();
                }
            } catch (e) {
                localStorage.removeItem('absensiAppSession');
            }
        }
    }

    // ==========================================================================
    // 3. UI NAVIGATION & SIDEBAR
    // ==========================================================================
    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active');
            el.style.display = 'none'; 
        });
        
        const target = document.getElementById(viewId);
        if (target) {
            target.classList.add('active');
            target.style.display = 'block'; 
            target.classList.add('animate-fade-in');
        }

        let title = "Dashboard";
        switch (viewId) {
            case 'view-data-siswa': title = "Direktori Siswa"; break;
            case 'view-data-guru': title = "Manajemen Guru"; break;
            case 'view-kelola-absen': title = "Kelola Hari Libur"; break; // JUDUL BARU
            case 'view-scanner': title = "Scan Absensi"; break;
            case 'view-monitoring': title = "Monitoring Realtime"; break;
            case 'view-rekap-absensi': title = "Laporan Kehadiran"; break;
            case 'view-kartu-siswa': title = "Kartu Pelajar Digital"; break;
        }
        document.getElementById('pageTitle').textContent = title;
        closeSidebarMobile();
    }

    function setActiveMenu(targetName) {
        const allLinks = document.querySelectorAll('#sidebarMenu a');
        
        const centerClass = !isSidebarOpen ? 'justify-center px-0' : 'space-x-3 px-4';
        const baseStyle = `flex items-center ${centerClass} py-3 rounded-xl transition-all duration-200 group overflow-hidden whitespace-nowrap cursor-pointer `;
        
        const activeStyle = "bg-indigo-600 text-white shadow-lg shadow-indigo-900/50";
        const inactiveStyle = "text-gray-400 hover:bg-gray-800 hover:text-white";

        allLinks.forEach(link => {
            const menuName = link.getAttribute('data-name');
            if (menuName === targetName) {
                link.className = baseStyle + activeStyle;
            } else {
                link.className = baseStyle + inactiveStyle;
            }
        });
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('mainContent');
        const overlay = document.getElementById('mobileOverlay');
        const labels = document.querySelectorAll('.sidebar-label');
        const header = document.getElementById('sidebarHeader');
        const userCard = document.getElementById('userProfileCard');
        const logoutBtn = document.getElementById('btnLogout');
        const menuLinks = document.querySelectorAll('#sidebarMenu a');

        const isMobile = window.innerWidth < 768;

        if (isMobile) {
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        } else {
            if (isSidebarOpen) {
                // COLLAPSE
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-20');
                main.classList.remove('md:ml-64');
                main.classList.add('md:ml-20');

                // Centering items
                header.classList.remove('px-6', 'justify-start'); header.classList.add('px-0', 'justify-center');
                userCard.classList.remove('space-x-3', 'p-3', 'bg-black/20', 'border'); userCard.classList.add('justify-center', 'p-0', 'bg-transparent', 'border-transparent');
                logoutBtn.classList.remove('space-x-3', 'justify-start', 'px-4'); logoutBtn.classList.add('justify-center', 'px-0');
                menuLinks.forEach(link => { link.classList.remove('space-x-3', 'px-4'); link.classList.add('justify-center', 'px-0'); });
                labels.forEach(el => { el.classList.add('hidden'); });

                isSidebarOpen = false;
            } else {
                // EXPAND
                sidebar.classList.remove('w-20');
                sidebar.classList.add('w-64');
                main.classList.remove('md:ml-20');
                main.classList.add('md:ml-64');

                // Reset items
                header.classList.add('px-6', 'justify-start'); header.classList.remove('px-0', 'justify-center');
                userCard.classList.add('space-x-3', 'p-3', 'bg-black/20', 'border'); userCard.classList.remove('justify-center', 'p-0', 'bg-transparent', 'border-transparent');
                logoutBtn.classList.add('space-x-3', 'justify-start', 'px-4'); logoutBtn.classList.remove('justify-center', 'px-0');
                menuLinks.forEach(link => { link.classList.add('space-x-3', 'px-4'); link.classList.remove('justify-center', 'px-0'); });
                labels.forEach(el => { el.classList.remove('hidden'); });

                isSidebarOpen = true;
            }
        }
    }

    function closeSidebarMobile() {
        if (window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            const overlay = document.getElementById('mobileOverlay');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
    }

    // ==========================================================================
    // 4. AUTENTIKASI
    // ==========================================================================
    function switchLoginTab(tab) {
        document.getElementById('loginError').classList.add('hidden');
        const btnSiswa = document.getElementById('btnSiswaTab');
        const btnAdmin = document.getElementById('btnAdminTab');
        
        const activeClass = "bg-white text-indigo-600 shadow-sm";
        const inactiveClass = "text-gray-500 hover:text-gray-700 hover:bg-gray-200";

        btnSiswa.className = `flex-1 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 ${tab === 'siswa' ? activeClass : inactiveClass}`;
        btnAdmin.className = `flex-1 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 ${tab === 'admin' ? activeClass : inactiveClass}`;

        if (tab === 'admin') {
            document.getElementById('formAdminLogin').classList.remove('hidden');
            document.getElementById('formSiswaLogin').classList.add('hidden');
        } else {
            document.getElementById('formAdminLogin').classList.add('hidden');
            document.getElementById('formSiswaLogin').classList.remove('hidden');
        }
    }

    function handleLogin(event) {
        event.preventDefault();
        showLoading();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const nisn = document.getElementById('nisn').value;

        google.script.run
            .withSuccessHandler(onLoginSuccess)
            .withFailureHandler(onLoginFailure)
            .login(username, password, nisn);
    }

    function onLoginSuccess(result) {
        hideLoading(); // Sembunyikan animasi loading
        
        if (result.success) {
            // 1. Simpan data user + TOKEN ke variabel global
            currentUser = result; 
            
            // 2. Simpan ke LocalStorage agar token bertahan saat refresh page
            localStorage.setItem('absensiAppSession', JSON.stringify(result));
            
            // 3. Update UI: Sembunyikan Login, Tampilkan Dashboard
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.remove('hidden');
            
            // 4. Inisialisasi Dashboard
            initDashboard();
        } else {
            // Tampilkan pesan error jika login gagal
            const errorDiv = document.getElementById('loginError');
            document.getElementById('errorText').textContent = result.message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
    }

    function onLoginFailure(error) {
        hideLoading();
        alert('Gagal terhubung ke server: ' + error.message);
    }

    function logout() {
        stopAndBack(false);
        localStorage.removeItem('absensiAppSession');
        currentUser = null;
        appCache = { siswa: null, guru: null };
        document.getElementById('dashboardContainer').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
        
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('nisn').value = '';
        document.getElementById('sidebar').classList.add('-translate-x-full');
    }

    // ==========================================================================
    // 5. DASHBOARD & MENU
    // ==========================================================================
function initDashboard() {
    const name = currentUser.nama || currentUser.username;
    document.getElementById('navUserName').textContent = name;
    
    // Tampilkan Role dengan format yang rapi
    let displayRole = currentUser.role.toUpperCase();
    if (currentUser.role === 'wakel') displayRole = 'WAKIL KEPALA SEKOLAH';
    document.getElementById('navUserRole').textContent = displayRole;
    
    document.getElementById('navUserInitial').textContent = name.charAt(0).toUpperCase();

    const menuContainer = document.getElementById('sidebarMenu');
    let menuHTML = '';

    // Helper untuk membuat HTML menu item
    const createItem = (label, icon, onclick, isDefaultActive = false) => {
        const hideText = !isSidebarOpen ? 'hidden' : ''; 
        const centerClass = !isSidebarOpen ? 'justify-center px-0' : 'space-x-3 px-4';
        const baseStyle = `flex items-center ${centerClass} py-3 rounded-xl transition-all duration-200 group overflow-hidden whitespace-nowrap cursor-pointer `;
        const activeStyle = "bg-indigo-600 text-white shadow-lg shadow-indigo-900/50";
        const inactiveStyle = "text-gray-400 hover:bg-gray-800 hover:text-white";
        const currentStyle = isDefaultActive ? (baseStyle + activeStyle) : (baseStyle + inactiveStyle);

        return `
        <a data-name="${label}" onclick="${onclick}" class="${currentStyle}">
            <i class="fas ${icon} w-6 text-center flex-shrink-0 group-hover:scale-110 transition-transform"></i>
            <span class="sidebar-label font-medium transition-opacity duration-300 ${hideText}">${label}</span>
        </a>`;
    };

    // --- MENU UNTUK ADMIN ---
    if (currentUser.role === 'admin') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadAdminDashboard()', true);
        menuHTML += createItem('Data Siswa', 'fa-user-graduate', 'loadDataSiswa()');
        menuHTML += createItem('Data Guru', 'fa-chalkboard-teacher', 'loadDataGuru()');
        menuHTML += createItem('Laporan', 'fa-clipboard-list', 'loadRekapAbsensi()');
        menuHTML += createItem('Rekap Bulanan', 'fa-calendar-alt', 'loadMenuRekapBulanan()');
        menuHTML += createItem('Kenaikan Kelas', 'fa-level-up-alt', 'loadKenaikanKelas()');
        menuHTML += createItem('Kelola Absen', 'fa-calendar-times', 'loadKelolaAbsen()'); 
        menuHTML += createItem('Scan Absensi', 'fa-qrcode', 'loadScanAbsensi()');
        
        loadAdminDashboard();
    } 
    // --- MENU UNTUK GURU ---
    else if (currentUser.role === 'guru') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadGuruDashboard()', true);
        menuHTML += createItem('Monitoring', 'fa-eye', 'loadMonitoringAbsensi()');
        menuHTML += createItem('Rekap Bulanan', 'fa-calendar-alt', 'loadMenuRekapBulanan()');
        menuHTML += createItem('Scan Absensi', 'fa-qrcode', 'loadScanAbsensi()');
        loadGuruDashboard();
    } 
    // --- MENU UNTUK WAKIL KEPALA SEKOLAH (BARU) ---
    else if (currentUser.role === 'wakel') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadAdminDashboard()', true);
        menuHTML += createItem('Laporan', 'fa-clipboard-list', 'loadRekapAbsensi()');
        menuHTML += createItem('Rekap Bulanan', 'fa-calendar-alt', 'loadMenuRekapBulanan()');
        loadAdminDashboard();
    }
    // --- MENU UNTUK SISWA ---
    else if (currentUser.role === 'siswa') {
        menuHTML += createItem('Dashboard', 'fa-home', 'loadSiswaDashboard()', true);
        menuHTML += createItem('Kartu Saya', 'fa-id-card', 'loadQRCodeSiswa()');
        loadSiswaDashboard();
    }

    // Render Menu ke HTML
    menuContainer.innerHTML = menuHTML;
    
    // --- AMBIL DATA KELAS (Untuk Autocomplete/Dropdown) ---
    loadKelasSuggestions();
}
    
    // --- DROPDOWN KELAS LOGIC ---
    function loadKelasSuggestions() {
        console.log("Memuat daftar kelas dari Konfigurasi...");
        
        google.script.run.withSuccessHandler(function(classes) {
            existingClasses = classes; // Simpan ke variabel global
            
            // Populate semua dropdown yang ada di HTML saat ini
            populateAllClassDropdowns();
            
        }).getDaftarKelas(); // Memanggil fungsi backend yang baru kita ubah
    }

function populateAllClassDropdowns() {
    const dropdownIds = [
        'filterKelas',      // Di Data Siswa
        'filterKelasGuru',  // Di Data Guru (jika ada)
        'rekapKelas',       // Di Rekap Bulanan
        'promoKelasAsal',   // Di Kenaikan Kelas
        'promoKelasTujuan'  // Di Kenaikan Kelas
    ];

    dropdownIds.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            // Simpan value yang sedang dipilih (jika ada) biar tidak ke-reset total
            const currentValue = select.value;
            
            // Simpan opsi default/pertama (biasanya "-- Pilih Kelas --" atau "Semua Kelas")
            const defaultOption = select.options[0] ? select.options[0].cloneNode(true) : null;
            
            // Opsional khusus: Untuk Promo Tujuan ada opsi LULUS
            let extraOption = null;
            if(id === 'promoKelasTujuan') {
               extraOption = select.querySelector('option[value="LULUS"]');
            }

            // Kosongkan dropdown
            select.innerHTML = '';
            
            // Kembalikan opsi default
            if (defaultOption) select.appendChild(defaultOption);
            if (extraOption) select.appendChild(extraOption.cloneNode(true));

            // Isi dengan data dari Konfigurasi
            existingClasses.forEach(kelas => {
                const option = document.createElement('option');
                option.value = kelas;
                option.text = kelas;
                select.appendChild(option);
            });

            // Restore value jika masih valid
            if (existingClasses.includes(currentValue)) {
                select.value = currentValue;
            }
        }
    });
}
    function openKelasDropdown() {
        const input = document.getElementById('inputKelas');
        const dropdown = document.getElementById('dropdownKelasList');
        if (!dropdown) return;
        renderKelasDropdown(existingClasses);
        dropdown.classList.remove('hidden');
    }

    function filterKelasDropdown(keyword) {
        const filtered = existingClasses.filter(c => c.toLowerCase().includes(keyword.toLowerCase()));
        renderKelasDropdown(filtered);
    }

    function renderKelasDropdown(items) {
        const dropdown = document.getElementById('dropdownKelasList');
        if (!items || items.length === 0) {
            dropdown.innerHTML = '<div class="px-4 py-3 text-xs text-gray-400 italic">Kelas tidak ditemukan. Ketik untuk membuat baru.</div>';
            return;
        }
        dropdown.innerHTML = items.map(kelas => `
            <div onclick="selectKelas('${kelas}')" class="px-4 py-2 hover:bg-indigo-50 cursor-pointer text-sm text-gray-700 transition-colors border-b border-gray-50 last:border-none">
                ${kelas}
            </div>
        `).join('');
    }

    function selectKelas(value) {
        const input = document.getElementById('inputKelas');
        if (input) {
            input.value = value;
            closeKelasDropdown();
        }
    }

    function closeKelasDropdown() {
        const dropdown = document.getElementById('dropdownKelasList');
        if (dropdown) {
            setTimeout(() => dropdown.classList.add('hidden'), 200);
        }
    }

    // ==========================================================================
    // 6. FUNGSI REFRESH DATA
    // ==========================================================================
function refreshData(type) {
        const btnIcon = event ? event.currentTarget.querySelector('i') : null;
        if(btnIcon) btnIcon.classList.add('fa-spin');

        if (type === 'siswa') {
            tableState.siswa.fullData = []; // Clear cache
            loadDataSiswa();       
            showAlert('success', 'Data siswa diperbarui.');
        } 
        else if (type === 'guru') {
             tableState.guru.fullData = []; // Clear cache
            loadDataGuru();        
            showAlert('success', 'Data guru diperbarui.');
        }
        else if (type === 'dashboard') {
            if (currentUser.role === 'admin') loadAdminDashboard();
            else if (currentUser.role === 'guru') loadGuruDashboard();
            else loadSiswaDashboard();
            showAlert('success', 'Statistik Dashboard diperbarui.');
        }

        else if (type === 'monitoring') {
            tableState.monitoring.fullData = []; 
            loadMonitoringAbsensi(); 
            showAlert('success', 'Data monitoring diperbarui.');
        }

        if(btnIcon) setTimeout(() => btnIcon.classList.remove('fa-spin'), 1000);
    }

    // ==========================================================================
    // 7. HALAMAN & LOGIKA DATA
    // ==========================================================================
    
    // --- ADMIN DASHBOARD ---
function loadAdminDashboard() {
    stopAndBack(false);
    setActiveMenu('Dashboard');
    showView('view-admin-dashboard');
    
    // Update Tanggal Header
    document.getElementById('adminDateDisplay').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // --- LOGIKA KHUSUS WAKIL KEPALA SEKOLAH ---
    const quickAccessPanel = document.getElementById('adminQuickAccess');
    const dashboardTitle = document.querySelector('#view-admin-dashboard h2');

    if (currentUser.role === 'wakel') {
        // Sembunyikan Akses Cepat (Scan, Data Siswa, dll)
        if(quickAccessPanel) quickAccessPanel.style.display = 'none';
        if(dashboardTitle) dashboardTitle.textContent = 'Dashboard Wakil Kepala Sekolah';
    } else {
        // Tampilkan untuk Admin
        if(quickAccessPanel) quickAccessPanel.style.display = 'block';
        if(dashboardTitle) dashboardTitle.textContent = 'Dashboard Admin';
    }
    // -------------------------------------------

    // Gunakan getMonitoringRealtime agar data konsisten dengan monitoring
    google.script.run.withSuccessHandler(result => {
        if (result.success) {
            const data = result.data;
            
            // 1. Hitung Statistik Global
            const total = data.length;
            const hadir = data.filter(d => d.status === 'Hadir').length;
            const sakit = data.filter(d => d.status === 'Sakit').length;
            const izin = data.filter(d => d.status === 'Izin').length;
            const alpa = data.filter(d => d.status === 'Alpa').length;
            const belum = data.filter(d => d.status === 'Belum Absen').length;

            // 2. Update Small Boxes (Animasi)
            animateValue("admStatTotal", 0, total, 800);
            animateValue("admStatHadir", 0, hadir, 800);
            animateValue("admStatSakit", 0, sakit, 800);
            animateValue("admStatIzin", 0, izin, 800);
            animateValue("admStatAlpa", 0, alpa, 800);

            // 3. Render Chart
            renderAdminChart(hadir, sakit, izin, alpa, belum);
        }
    }).getMonitoringRealtime();
}

    function renderAdminChart(hadir, sakit, izin, alpa, belum) {
        const ctx = document.getElementById('adminAttendanceChart');
        if (!ctx) return;

        if (adminChartInstance) {
            adminChartInstance.destroy();
        }

        if (typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); }

        adminChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Hadir', 'Sakit', 'Izin', 'Alpa', 'Belum Absen'],
                datasets: [{
                    label: 'Jumlah Siswa',
                    data: [hadir, sakit, izin, alpa, belum],
                    backgroundColor: [
                        '#10B981', // Emerald (Hadir)
                        '#EAB308', // Yellow (Sakit)
                        '#3B82F6', // Blue (Izin)
                        '#EF4444', // Red (Alpa)
                        '#9CA3AF'  // Gray (Belum)
                    ],
                    borderRadius: 8,
                    barPercentage: 0.5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: (val) => val > 0 ? val : '',
                        font: { weight: 'bold' },
                        color: '#666'
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- GURU DASHBOARD ---
function loadGuruDashboard() {
    stopAndBack(false);
    setActiveMenu('Dashboard');
    showView('view-guru-dashboard');
    
    document.getElementById('guruDashboardDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    // Kirim currentUser.kelas sebagai filter
    // Jika currentUser.kelas kosong (admin/guru umum), maka akan menampilkan semua
    const myClass = currentUser.role === 'guru' ? currentUser.kelas : null;

    google.script.run.withSuccessHandler(result => {
        if (result.success) {
            const data = result.data; 
            // ... (sisa kode sama: hitung statistik & render chart) ...
            
            // Tambahan: Ubah judul jika filter aktif
            if(myClass) {
                 document.querySelector('#view-guru-dashboard h2').textContent = `Dashboard Guru (${myClass})`;
            }
            
            // ... (lanjutkan kode chart render)
            const totalSiswa = data.length;
            const sakit = data.filter(d => d.status === 'Sakit').length;
            const izin = data.filter(d => d.status === 'Izin').length;
            const alpa = data.filter(d => d.status === 'Alpa').length;
            const hadir = data.filter(d => d.status === 'Hadir').length;
            const belumAbsen = data.filter(d => d.status === 'Belum Absen').length;

            animateValue("statGuruTotal", 0, totalSiswa, 1000);
            animateValue("statGuruSakit", 0, sakit, 1000);
            animateValue("statGuruIzin", 0, izin, 1000);
            animateValue("statGuruAlpa", 0, alpa, 1000);
            renderGuruChart(hadir, sakit, izin, alpa, belumAbsen);
        }
    }).getMonitoringRealtime(myClass); // Pass Parameter
}

    // Fungsi Render Chart Guru
    function renderGuruChart(hadir, sakit, izin, alpa, belumAbsen) {
        const ctx = document.getElementById('guruAttendanceChart');
        if (!ctx) return;

        // Hapus chart lama jika ada (mencegah glitch overlap)
        if (guruChartInstance) {
            guruChartInstance.destroy();
        }

        if (typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); }

        guruChartInstance = new Chart(ctx, {
            type: 'bar', // Diagram Batang
            data: {
                labels: ['Hadir', 'Sakit', 'Izin', 'Alpa', 'Belum Absen'],
                datasets: [{
                    label: 'Jumlah Siswa',
                    data: [hadir, sakit, izin, alpa, belumAbsen],
                    backgroundColor: [
                        '#10B981', // Hadir (Green)
                        '#F59E0B', // Sakit (Yellow)
                        '#3B82F6', // Izin (Blue)
                        '#EF4444', // Alpa (Red)
                        '#9CA3AF'  // Belum Absen (Gray)
                    ],
                    borderRadius: 6,
                    barPercentage: 0.6,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }, // Sembunyikan legenda default
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => value > 0 ? value : '', // Hanya tampilkan label jika > 0
                        font: { weight: 'bold', size: 11 },
                        color: '#4B5563'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [2, 4], color: '#F3F4F6' },
                        ticks: { stepSize: 1 }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Helper: Animasi Angka (Counter Up)
    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // --- SISWA DASHBOARD (DENGAN CEK LIBUR) ---
    function loadSiswaDashboard() {
        stopAndBack(false);
        setActiveMenu('Dashboard');
        showView('view-siswa-dashboard');
        showLoading();

        try {
            const safeSetText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            if (currentUser) {
                const firstName = currentUser.nama ? currentUser.nama.split(' ')[0] : 'Siswa';
                safeSetText('dashGreeting', firstName);
                safeSetText('profileNameSidebar', currentUser.nama);
                safeSetText('profileNisnSidebar', currentUser.nisn);
                safeSetText('profileKelasSidebar', currentUser.kelas);
            }
            const today = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            safeSetText('dashDate', today);
        } catch (e) {}

        google.script.run.withSuccessHandler(result => {
            hideLoading();
            try {
                const absensi = result && result.success ? result.data : null;
                const isLibur = result.isLibur; // Status libur dari server
                const infoLibur = result.keteranganLibur;

                const elHero = document.getElementById('heroCard');
                const elBadge = document.getElementById('dashStatusBadge');
                const elValMasuk = document.getElementById('valMasuk');
                const elValPulang = document.getElementById('valPulang');
                const elAlert = document.getElementById('alertBelumAbsen');

                // 1. MODE HARI LIBUR
                if (isLibur) {
                    if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-gradient-to-br from-rose-600 to-red-800 p-6 text-white shadow-xl shadow-rose-200 transition-all duration-500 group";
                    
                    if (elBadge) {
                        elBadge.className = "px-4 py-2 rounded-xl bg-white/20 backdrop-blur-md border border-white/20 text-white text-xs font-bold shadow-sm";
                        elBadge.innerHTML = `<i class="fas fa-calendar-times mr-2"></i> HARI LIBUR`;
                    }
                    
                    if (elValMasuk) {
                        elValMasuk.parentElement.innerHTML = `
                            <div class="text-center py-2">
                                <i class="fas fa-mug-hot text-3xl mb-2 opacity-80"></i>
                                <p class="text-sm font-bold uppercase tracking-widest">${infoLibur}</p>
                                <p class="text-[10px] mt-1 opacity-75">Tidak ada absensi hari ini</p>
                            </div>
                        `;
                        if(elValPulang) elValPulang.parentElement.style.display = 'none';
                        if(elValMasuk) elValMasuk.parentElement.classList.add('col-span-2');
                    }

                    if (elAlert) { elAlert.classList.add('hidden'); elAlert.classList.remove('flex'); }
                    return; 
                }

                // 2. MODE NORMAL (TIDAK LIBUR)
                // (Note: Idealnya kita reset style elValMasuk di sini jika aplikasi SPA kompleks)
                
                if (!absensi) {
                    if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-slate-800 p-6 text-white shadow-xl shadow-slate-200 transition-all duration-500 group";
                    if (elBadge) {
                        elBadge.className = "px-4 py-2 rounded-xl bg-rose-500/20 backdrop-blur-md border border-rose-500/30 text-rose-200 text-xs font-bold shadow-sm animate-pulse";
                        elBadge.innerHTML = `<i class="fas fa-circle text-[8px] mr-2"></i> BELUM ABSEN`;
                    }
                    if (elValMasuk) elValMasuk.textContent = "--:--";
                    if (elValPulang) elValPulang.textContent = "--:--";
                    if (elAlert) { elAlert.classList.remove('hidden'); elAlert.classList.add('flex'); }
                } else {
                    if (elAlert) { elAlert.classList.add('hidden'); elAlert.classList.remove('flex'); }
                    if (elValMasuk) elValMasuk.textContent = absensi.jamDatang || "--:--";
                    
                    if (!absensi.jamPulang) {
                        if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-gradient-to-br from-emerald-600 to-teal-800 p-6 text-white shadow-xl shadow-emerald-200 transition-all duration-500 group";
                        if (elBadge) {
                            elBadge.className = "px-4 py-2 rounded-xl bg-white/20 backdrop-blur-md border border-white/20 text-white text-xs font-bold shadow-sm";
                            elBadge.innerHTML = `<i class="fas fa-clock animate-pulse mr-2"></i> SEDANG BERLANGSUNG`;
                        }
                        if (elValPulang) elValPulang.textContent = "--:--";
                    } else {
                        if (elHero) elHero.className = "relative overflow-hidden rounded-3xl bg-gradient-to-br from-indigo-600 to-violet-800 p-6 text-white shadow-xl shadow-indigo-200 transition-all duration-500 group";
                        if (elBadge) {
                            elBadge.className = "px-4 py-2 rounded-xl bg-white/20 backdrop-blur-md border border-white/20 text-white text-xs font-bold shadow-sm";
                            elBadge.innerHTML = `<i class="fas fa-check-circle mr-2"></i> SELESAI HARI INI`;
                        }
                        if (elValPulang) elValPulang.textContent = absensi.jamPulang;
                    }
                }
            } catch (err) { console.error("Error rendering dashboard:", err); }
        }).withFailureHandler(error => { hideLoading(); }).getAbsensiToday(currentUser.nisn);
    }

    // --- KELOLA HARI LIBUR (ADMIN) ---
// --- KELOLA WAKTU & HARI LIBUR (ADMIN) ---
    function loadKelolaAbsen() {
        stopAndBack(false);
        setActiveMenu('Kelola Absen');
        showView('view-kelola-absen');
        
        // 1. Load Data Hari Libur (Seperti Biasa)
        document.getElementById('tbody-libur').innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data...</td></tr>';
        
        google.script.run.withSuccessHandler(result => {
            if (result.success) {
                tableState.libur.fullData = result.data;
                processTableData('libur');
            } else {
                document.getElementById('tbody-libur').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>';
            }
        }).getHariLibur();

        // 2. Load Data Konfigurasi Jam (BARU)
        loadGlobalConfig();
    }

    function loadGlobalConfig() {
        // Disable input while loading
        const inputs = document.querySelectorAll('#view-kelola-absen input[type="time"]');
        inputs.forEach(el => el.disabled = true);

        google.script.run.withSuccessHandler(res => {
            inputs.forEach(el => el.disabled = false);
            if(res.success) {
                const conf = res.data;
                document.getElementById('conf_masuk_mulai').value = conf.jam_masuk_mulai;
                document.getElementById('conf_masuk_akhir').value = conf.jam_masuk_akhir;
                document.getElementById('conf_pulang_mulai').value = conf.jam_pulang_mulai;
                document.getElementById('conf_pulang_akhir').value = conf.jam_pulang_akhir;
            }
        }).getAppConfig();
    }

    function saveGlobalConfig(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSaveConfig');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menyimpan...';
        
        const formData = new FormData(e.target);
        const newConfig = {
            jam_masuk_mulai: formData.get('jam_masuk_mulai'),
            jam_masuk_akhir: formData.get('jam_masuk_akhir'),
            jam_pulang_mulai: formData.get('jam_pulang_mulai'),
            jam_pulang_akhir: formData.get('jam_pulang_akhir')
        };

        google.script.run.withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            if(res.success) {
                showAlert('success', 'Pengaturan waktu berhasil disimpan!');
            } else {
                showAlert('error', res.message);
            }
        }).withFailureHandler(err => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            showAlert('error', 'Gagal koneksi: ' + err);
        }).saveAppConfig(newConfig);
    }

    function renderLiburRows(data, startIdx) {
            const tbody = document.getElementById('tbody-libur');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">Tidak ada jadwal libur.</td></tr>';
                return;
            }
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            tbody.innerHTML = data.map((item, i) => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 transition group">
                    <td class="p-4 text-center text-gray-500">${startIdx + i + 1}</td>
                    <td class="p-4 font-mono font-medium text-indigo-700">
                        ${new Date(item.tanggal).toLocaleDateString('id-ID', options)}
                    </td>
                    <td class="p-4 font-bold text-gray-700">${item.keterangan}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center space-x-2 opacity-80 group-hover:opacity-100">
                            <button onclick="editLibur('${item.tanggal}', '${item.keterangan}')" class="p-2 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLiburConfirm('${item.tanggal}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

  // 1. Fungsi Trigger saat tombol edit ditekan
      function editLibur(tgl, ket) {
          // Tampilkan modal dengan data yang sudah terisi
          showModal(createLiburModal({ tanggal: tgl, keterangan: ket }));
      }

      function createLiburModal(data) {
              const inputClass = "w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-3 transition-all mb-4";
              
              return `
              <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative overflow-hidden animate-fade-in">
                  <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                      <i class="fas fa-times"></i>
                  </button>
                  
                  <div class="text-center mb-6">
                      <div class="w-14 h-14 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm">
                          <i class="fas fa-calendar-day"></i>
                      </div>
                      <h3 class="font-bold text-xl text-gray-800">Edit Hari Libur</h3>
                      <p class="text-xs text-gray-500 mt-1">Perbarui tanggal atau keterangan</p>
                  </div>
                  
                  <form onsubmit="saveUpdateLibur(event)">
                      <input type="hidden" name="oldDate" value="${data.tanggal}">
                      
                      <label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Tanggal</label>
                      <input type="date" name="newDate" value="${data.tanggal}" required class="${inputClass}">
                      
                      <label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Keterangan</label>
                      <input type="text" name="newKeterangan" value="${data.keterangan}" required placeholder="Contoh: Cuti Bersama" class="${inputClass}">

                      <div class="flex gap-3 mt-4">
                          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">
                              Batal
                          </button>
                          <button type="submit" id="btnSaveLibur" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                              Simpan Perubahan
                          </button>
                      </div>
                  </form>
              </div>`;
          }

          // 3. Fungsi Simpan Perubahan (Submit Form Modal)
      function saveUpdateLibur(e) {
        e.preventDefault();
        
        // 1. Ambil elemen tombol
        const btn = document.getElementById('btnSaveLibur');
        const originalText = btn.innerHTML; // Simpan teks asli
        
        // 2. Ubah tampilan tombol menjadi Loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menyimpan...';
        btn.classList.add('opacity-75', 'cursor-not-allowed'); // Visual feedback tambahan

        // Tetap tampilkan loading overlay global (opsional, bisa dihapus jika ingin hanya tombol saja)
        showLoading(); 
        
        const fd = new FormData(e.target);
        const oldDate = fd.get('oldDate');
        const newDate = fd.get('newDate');
        const newKet = fd.get('newKeterangan');
        
        google.script.run.withSuccessHandler(res => {
            hideLoading(); // Sembunyikan overlay global
            
            // 3. Kembalikan tombol ke keadaan semula (penting jika terjadi error)
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');

            if (res.success) {
                closeModal();
                loadKelolaAbsen(); 
                showAlert('success', res.message);
            } else {
                showAlert('error', res.message);
            }
        })
        .withFailureHandler(error => {
            // Handler jika koneksi gagal total
            hideLoading();
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
            showAlert('error', 'Gagal menghubungi server: ' + error);
        })
        .updateHariLibur(oldDate, newDate, newKet);
    }
            
    function handleAddLibur(e) {
        e.preventDefault();
        showLoading();
        const fd = new FormData(e.target);
        const tgl = fd.get('tanggal');
        const ket = fd.get('keterangan');

        google.script.run.withSuccessHandler(res => {
            hideLoading();
            if (res.success) {
                e.target.reset(); // Reset form
                loadKelolaAbsen(); // Reload tabel
                showAlert('success', 'Jadwal libur ditambahkan');
            } else {
                showAlert('error', res.message);
            }
        }).addHariLibur(tgl, ket);
    }

    function deleteLiburConfirm(tgl) {
        if (confirm('Hapus hari libur ini? Siswa akan bisa absen kembali pada tanggal tersebut.')) {
            showLoading();
            google.script.run.withSuccessHandler(res => {
                hideLoading();
                loadKelolaAbsen();
                showAlert('success', 'Jadwal libur dihapus');
            }).deleteHariLibur(tgl);
        }
    }

    // --- DATA SISWA ---
// 
// Cari function loadDataSiswa() dan GANTI SEMUANYA dengan ini:

function loadDataSiswa() {
    stopAndBack(false);
    setActiveMenu('Data Siswa');
    showView('view-data-siswa');
    
    // 1. Tentukan Filter Kelas Berdasarkan Role
    // Jika Admin: null (Tampilkan Semua), Jika Guru: Ambil dari currentUser.kelas
    const filterKelas = (currentUser.role === 'guru') ? currentUser.kelas : null;

    // --- JUDUL HALAMAN DISESUAIKAN ---
    const pageTitle = document.querySelector('#view-data-siswa h3');
    if (filterKelas) {
        pageTitle.textContent = `Direktori Siswa (Kelas ${filterKelas})`;
        // Sembunyikan dropdown filter kelas karena guru hanya boleh lihat kelasnya
        document.getElementById('filterKelasSiswa').parentElement.style.display = 'none';
    } else {
        pageTitle.textContent = 'Direktori Siswa';
        // Tampilkan dropdown filter untuk Admin
        document.getElementById('filterKelasSiswa').parentElement.style.display = 'flex';
    }

    // --- LOGIKA POPULATE DROPDOWN (Khusus Admin) ---
    const dropdown = document.getElementById('filterKelasSiswa');
    const fillDropdown = (dataKelas) => {
        if (!dropdown) return;
        const currentValue = dropdown.value; 
        let options = '<option value="">Semua Kelas</option>';
        if (dataKelas && dataKelas.length > 0) {
            dataKelas.forEach(kelas => {
                options += `<option value="${kelas}">${kelas}</option>`;
            });
        }
        dropdown.innerHTML = options;
        if (currentValue) dropdown.value = currentValue;
    };

    if (existingClasses && existingClasses.length > 0) {
        fillDropdown(existingClasses);
    } else {
        dropdown.innerHTML = '<option value="">Memuat data...</option>';
        google.script.run.withSuccessHandler(result => {
            if (result.success) {
                existingClasses = result.data;
                fillDropdown(existingClasses);
            }
        }).getKelasList();
    }

    // --- AMBIL DATA SISWA DENGAN PARAMETER FILTER ---
    // Reset tabel dulu agar terlihat loading
    document.getElementById('tbody-siswa').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data siswa...</td></tr>';
    
    // Panggil Backend dengan parameter filterKelas
    google.script.run.withSuccessHandler(result => {
        if (result.success) {
            tableState.siswa.fullData = result.data;
            processTableData('siswa');
        } else {
            showAlert('error', result.message);
        }
    }).getSiswaList(filterKelas); // <--- PERUBAHAN UTAMA DISINI
}

function renderSiswaRows(data, startIdx) {
        const tbody = document.getElementById('tbody-siswa');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Data tidak ditemukan.</td></tr>';
            return;
        }
        tbody.innerHTML = data.map((siswa, i) => `
        <tr class="hover:bg-gray-50 transition border-b border-gray-50 group">
            <td class="p-4 text-center text-gray-500 text-sm">${startIdx + i + 1}</td>
            <td class="p-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-3">
                        ${siswa.nama.charAt(0)}
                    </div>
                    <div>
                        <div class="font-bold text-sm text-gray-900">${siswa.nama}</div>
                        <div class="text-xs text-gray-500 md:hidden">${siswa.nisn}</div>
                    </div>
                </div>
            </td>
            <td class="p-4 hidden md:table-cell text-sm text-gray-600 font-mono">${siswa.nisn}</td>
            <td class="p-4 hidden sm:table-cell"><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-bold">${siswa.kelas}</span></td>
            <td class="p-4 text-center">
                <div class="flex justify-center space-x-2 opacity-80 group-hover:opacity-100">
                    <button onclick='viewSiswa(${JSON.stringify(siswa)})' class="p-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 transition" title="Lihat Detail">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    <button onclick='editSiswa(${JSON.stringify(siswa)})' class="p-2 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition" title="Edit"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteSiswaConfirm('${siswa.nisn}', '${siswa.nama}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition" title="Hapus"><i class="fas fa-trash"></i></button>
                    <button onclick="generateQRForSiswa('${siswa.nisn}', '${siswa.nama}', '${siswa.kelas}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition" title="QR Code"><i class="fas fa-qrcode"></i></button>
                </div>
            </td>
        </tr>`).join('');
    }

    // --- DATA GURU ---
function loadDataGuru() {
        stopAndBack(false);
        setActiveMenu('Data Guru');
        showView('view-data-guru');
        
        // --- LOGIKA POPULATE DROPDOWN KELAS GURU ---
        const dropdown = document.getElementById('filterKelasGuru');
        if (dropdown && existingClasses && existingClasses.length > 0) {
            const currentValue = dropdown.value; 
            
            let options = '<option value="">Semua Kelas</option>';
            existingClasses.forEach(kelas => {
                options += `<option value="${kelas}">${kelas}</option>`;
            });
            dropdown.innerHTML = options;
            
            if (currentValue) dropdown.value = currentValue;
        }
        // --------------------------------------------------

        // Cek Cache Data
        if (tableState.guru.fullData.length > 0) {
            processTableData('guru');
        } else {
            // Tampilkan Loading di Tabel
            document.getElementById('tbody-guru').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data guru...</td></tr>';
            
            // === KEAMANAN: AMBIL TOKEN ===
            const token = currentUser.token;

            // Panggil Backend dengan Token
            google.script.run.withSuccessHandler(result => {
                if (result.success) {
                    tableState.guru.fullData = result.data;
                    processTableData('guru');
                } else {
                    // Jika gagal (Token invalid/Bukan Admin)
                    document.getElementById('tbody-guru').innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500 font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>${result.message}</td></tr>`;
                    showAlert('error', result.message);
                }
            })
            .withFailureHandler(error => {
                document.getElementById('tbody-guru').innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500">Gagal koneksi: ${error}</td></tr>`;
            })
            .getGuruList(token); // <-- PARAMETER TOKEN DITAMBAHKAN DI SINI
        }
    }

// UPDATE: Menampilkan kolom kelas di tabel
function renderGuruRows(data, startIdx) {
    const tbody = document.getElementById('tbody-guru');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Data tidak ditemukan.</td></tr>';
        return;
    }
    // Note: Pastikan header tabel di HTML juga ditambah 1 kolom "Kelas"
    tbody.innerHTML = data.map((guru, i) => `
    <tr class="hover:bg-gray-50 transition border-b border-gray-50 group">
        <td class="p-4 text-center text-gray-500 text-sm">${startIdx + i + 1}</td>
        <td class="p-4 text-sm font-bold text-gray-800">${guru.username}</td>
        <td class="p-4 text-sm text-gray-600">
            ${guru.kelas ? `<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">${guru.kelas}</span>` : '<span class="text-gray-400 italic text-xs">Semua Akses</span>'}
        </td>
        <td class="p-4 text-sm text-gray-400 font-mono">••••••••</td>
        <td class="p-4 text-center">
            <div class="flex justify-center space-x-2 opacity-80 group-hover:opacity-100">
                <button onclick='editGuru(${JSON.stringify(guru)})' class="p-2 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition" title="Edit Akun"><i class="fas fa-edit"></i></button>
                <button onclick="deleteGuruConfirm('${guru.username}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition" title="Hapus Akun"><i class="fas fa-trash"></i></button>
            </div>
        </td>
    </tr>`).join('');
}
function saveSiswa(e, isEdit) {
    e.preventDefault();
    showLoading();

    const fd = new FormData(e.target);
    const siswaData = {
        nama: fd.get('nama'),
        nisn: "'" + fd.get('nisn'),
        jenisKelamin: fd.get('jenisKelamin'),
        tanggalLahir: fd.get('tanggalLahir'),
        agama: fd.get('agama'),
        namaAyah: fd.get('namaAyah'),
        namaIbu: fd.get('namaIbu'),
        noHp: "'" + fd.get('noHp'),
        kelas: fd.get('kelas'),
        alamat: fd.get('alamat')
    };

    // --- PERUBAHAN UTAMA DISINI ---
    // Ambil token dari user yang sedang login
    const token = currentUser ? currentUser.token : null; 
    // ------------------------------

    const callback = (res) => {
        hideLoading();
        if (res.success) {
            closeModal();
            tableState.siswa.fullData = [];
            loadDataSiswa();
            showAlert('success', res.message);
        } else {
            showAlert('error', res.message);
        }
    };

    const failureCallback = (err) => {
        hideLoading();
        showAlert('error', 'Terjadi kesalahan: ' + err);
    };

    // Kirim Token ke Server
    if (isEdit) {
        const oldNisn = fd.get('oldNisn');
        google.script.run
            .withSuccessHandler(callback)
            .withFailureHandler(failureCallback)
            .updateSiswa(token, oldNisn, siswaData); // <-- Pastikan updateSiswa di code.gs juga sudah ditambah parameter token!
    } else {
        google.script.run
            .withSuccessHandler(callback)
            .withFailureHandler(failureCallback)
            .addSiswa(token, siswaData); // <-- KIRIM TOKEN
    }
}
    // --- REKAP ABSENSI ---
function loadRekapAbsensi() {
    stopAndBack(false);
    setActiveMenu('Laporan');
    showView('view-rekap-absensi');
    
    // 1. Reset Tampilan (Bersihkan tabel lama)
    document.getElementById('rekapEmptyState').classList.remove('hidden');
    document.getElementById('rekapContainer').classList.add('hidden');
    document.getElementById('rekapLoading').classList.add('hidden');
    
    // Reset data di memori
    tableState.rekap.fullData = [];

    // 2. Logika Pengisian Dropdown Kelas (Anti-Kosong)
    const selectKelas = document.getElementById('fKelasRekap');
    
    // Fungsi pembantu untuk render opsi HTML
    const fillDropdown = (dataKelas) => {
        if (!selectKelas) return;
        
        // Simpan nilai yang mungkin sudah dipilih user sebelumnya (jika reload)
        const currentVal = selectKelas.value; 
        
        let options = '<option value="">Semua Kelas</option>';
        if (dataKelas && dataKelas.length > 0) {
            dataKelas.forEach(kelas => {
                options += `<option value="${kelas}">${kelas}</option>`;
            });
        }
        selectKelas.innerHTML = options;
        
        // Kembalikan pilihan user jika masih valid
        if (currentVal) selectKelas.value = currentVal;
    };

    // --- CEK DATA KELAS ---
    // A. Jika data kelas sudah tersimpan di variabel global 'existingClasses'
    if (existingClasses && existingClasses.length > 0) {
        fillDropdown(existingClasses);
    } 
    // B. Jika data masih kosong (karena aplikasi baru dibuka), ambil paksa dari server
    else {
        if (selectKelas) selectKelas.innerHTML = '<option value="">Memuat data...</option>';
        
        google.script.run.withSuccessHandler(result => {
            if (result.success) {
                existingClasses = result.data; // Simpan ke global agar akses berikutnya cepat
                fillDropdown(existingClasses); // Render ke dropdown
            }
        }).getKelasList();
    }
}

function applyFilter() {
        const emptyState = document.getElementById('rekapEmptyState');
        const container = document.getElementById('rekapContainer');
        const loading = document.getElementById('rekapLoading');

        emptyState.classList.add('hidden');
        container.classList.add('hidden');
        loading.classList.remove('hidden');

        // UPDATE: Ambil nilai kelas juga
        const filter = {
            tanggalMulai: document.getElementById('fStart').value,
            tanggalAkhir: document.getElementById('fEnd').value,
            kelas: document.getElementById('fKelasRekap').value // BARU
        };

        google.script.run.withSuccessHandler(result => {
            loading.classList.add('hidden');
            container.classList.remove('hidden');
            
            if (result.success) {
                tableState.rekap.fullData = result.data;
                processTableData('rekap');
            } else {
                 tableState.rekap.fullData = [];
                 processTableData('rekap');
            }
        }).getAbsensiList(filter);
    }

// --- REKAP ABSENSI ---
    function loadRekapAbsensi() {
        stopAndBack(false);
        setActiveMenu('Laporan');
        showView('view-rekap-absensi');
        
        // Reset View State
        document.getElementById('rekapEmptyState').classList.remove('hidden');
        document.getElementById('rekapContainer').classList.add('hidden');
        document.getElementById('rekapLoading').classList.add('hidden');
        tableState.rekap.fullData = [];

        // UPDATE: Populate Dropdown Kelas dari data global existingClasses
        const selectKelas = document.getElementById('fKelasRekap');
        if (selectKelas) {
            // Reset opsi, sisakan "Semua Kelas"
            selectKelas.innerHTML = '<option value="">Semua Kelas</option>';
            
            // Masukkan data kelas yang sudah diambil saat initDashboard
            if (existingClasses && existingClasses.length > 0) {
                existingClasses.forEach(kelas => {
                    const option = document.createElement('option');
                    option.value = kelas;
                    option.textContent = kelas;
                    selectKelas.appendChild(option);
                });
            }
        }
    }

    function applyFilter() {
        const emptyState = document.getElementById('rekapEmptyState');
        const container = document.getElementById('rekapContainer');
        const loading = document.getElementById('rekapLoading');

        emptyState.classList.add('hidden');
        container.classList.add('hidden');
        loading.classList.remove('hidden');

        // UPDATE: Ambil nilai kelas juga
        const filter = {
            tanggalMulai: document.getElementById('fStart').value,
            tanggalAkhir: document.getElementById('fEnd').value,
            kelas: document.getElementById('fKelasRekap').value // BARU
        };

        google.script.run.withSuccessHandler(result => {
            loading.classList.add('hidden');
            container.classList.remove('hidden');
            
            if (result.success) {
                tableState.rekap.fullData = result.data;
                processTableData('rekap');
            } else {
                 tableState.rekap.fullData = [];
                 processTableData('rekap');
            }
        }).getAbsensiList(filter);
    }

    function exportToExcel() {
        const start = document.getElementById('fStart').value;
        const end = document.getElementById('fEnd').value;
        // UPDATE: Ambil nilai kelas
        const kelas = document.getElementById('fKelasRekap').value; 

        if (!start || !end) {
            showAlert('error', 'Harap pilih rentang tanggal terlebih dahulu.');
            return;
        }

        const btn = document.getElementById('btnExportExcel');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Memproses...';
        
        // UPDATE: Masukkan kelas ke object filters
        const filters = {
            tanggalMulai: start,
            tanggalAkhir: end,
            kelas: kelas // BARU
        };

        google.script.run.withSuccessHandler(result => {
            btn.disabled = false;
            btn.innerHTML = originalText;

            if (result.success) {
                window.open(result.url, '_blank');
                showAlert('success', 'File Excel berhasil diunduh!');
            } else {
                showAlert('error', result.message);
            }
        })
        .withFailureHandler(err => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            showAlert('error', 'Terjadi kesalahan server: ' + err);
        })
        .generateExcel('laporan_absensi', filters);
    }

function renderRekapRows(data) {
    const tbody = document.getElementById('tbody-rekap');
    
    // Update colspan jadi 8 karena kolom bertambah
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-gray-400">Tidak ada data ditemukan.</td></tr>';
        return;
    }
    
    // Helper untuk warna badge STATUS (Kolom H)
    const getStatusColor = (status) => {
         if(status === 'Hadir') return 'bg-green-100 text-green-700';
         if(status === 'Izin') return 'bg-blue-100 text-blue-700';
         if(status === 'Sakit') return 'bg-yellow-100 text-yellow-700';
         if(status === 'Alpa') return 'bg-red-100 text-red-700';
         return 'bg-gray-100 text-gray-600';
    };

    tbody.innerHTML = data.map((d, i) => {
        
        // Helper untuk warna teks KETERANGAN (Kolom G)
        let ketText = d.keterangan || "-";
        let ketStyle = "text-gray-500";
        let ketIcon = "";
        
        if (String(ketText).includes("Terlambat")) {
            ketStyle = "text-rose-600 font-bold bg-rose-50 px-2 py-1 rounded border border-rose-100 text-[10px]";
            ketIcon = '<i class="fas fa-history mr-1"></i>';
        } else if (String(ketText).includes("Pulang Cepat")) {
            ketStyle = "text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded border border-orange-100 text-[10px]";
            ketIcon = '<i class="fas fa-running mr-1"></i>';
        } else if (ketText === "Tepat Waktu") {
            ketStyle = "text-emerald-600 font-bold text-[10px]";
            ketIcon = '<i class="fas fa-check-double mr-1"></i>';
        }

        return `
        <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
            <td class="p-4 text-center text-gray-500 text-xs">${i + 1}</td>
            
            <td class="p-4 text-sm text-gray-600">
               ${new Date(d.tanggal).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'})}
            </td>
            
            <td class="p-4 text-sm font-bold text-gray-900">${d.nama}</td>
            
            <td class="p-4 text-center text-sm text-gray-600">
               <span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">${d.kelas}</span>
            </td>
            
            <td class="p-4 text-center text-sm font-mono text-gray-600">${d.jamDatang}</td>
            <td class="p-4 text-center text-sm font-mono text-gray-600">${d.jamPulang}</td>
            
            <td class="p-4 text-center align-middle">
               <span class="${ketStyle} inline-block whitespace-nowrap">${ketIcon}${ketText}</span>
            </td>
            
            <td class="p-4 text-center text-sm">
                <span class="${getStatusColor(d.status)} px-2 py-1 rounded text-xs font-bold">
                   ${d.status || 'Hadir'}
                </span>
            </td>
        </tr>`;
    }).join('');
}

    // --- MONITORING ---
function loadMonitoringAbsensi() {
    stopAndBack(false);
    setActiveMenu('Monitoring');
    showView('view-monitoring');
    document.getElementById('monitoringDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    
    // --- UPDATE: Set Default Tanggal Export ke Hari Ini ---
    const todayISO = new Date().toISOString().split('T')[0];
    const elStart = document.getElementById('exportMonStart');
    const elEnd = document.getElementById('exportMonEnd');
    
    // Hanya set jika kosong (agar tidak mereset pilihan user jika tab berpindah)
    if(elStart && !elStart.value) elStart.value = todayISO;
    if(elEnd && !elEnd.value) elEnd.value = todayISO;
    // -----------------------------------------------------

    // Tentukan filter kelas (Guru Wali Kelas vs Admin)
    const myClass = currentUser.role === 'guru' ? currentUser.kelas : null;

    if (tableState.monitoring.fullData.length > 0) {
        processTableData('monitoring');
    } else {
        document.getElementById('tbody-monitoring').innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data...</td></tr>';
        google.script.run.withSuccessHandler(result => {
            if (result.success) {
                tableState.monitoring.fullData = result.data;
                processTableData('monitoring');
            } else {
                document.getElementById('tbody-monitoring').innerHTML = '<tr><td colspan="7" class="p-12 text-center text-gray-400 italic bg-white">Data tidak ditemukan.</td></tr>';
            }
        }).getMonitoringRealtime(myClass);
    }
}

function exportMonitoringExcel() {
    // 1. Ambil elemen tombol
    const btn = document.getElementById('btnExportMonitoring');
    const originalContent = btn.innerHTML;

    // 2. AMBIL TANGGAL DARI INPUT (BARU)
    const startDate = document.getElementById('exportMonStart').value;
    const endDate = document.getElementById('exportMonEnd').value;

    if (!startDate || !endDate) {
        showAlert('error', 'Harap pilih tanggal mulai dan akhir untuk export.');
        return;
    }

    // 3. Ubah tampilan tombol menjadi "Loading"
    btn.disabled = true;
    btn.classList.add('cursor-not-allowed', 'opacity-75');
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> <span class="hidden sm:inline">Memproses...</span>';
    
    // 4. Siapkan Filter
    const myClass = (currentUser && currentUser.role === 'guru') ? currentUser.kelas : null;
    
    const filters = {
        kelas: myClass,
        tanggalMulai: startDate, // Kirim parameter tanggal
        tanggalAkhir: endDate
    };

    // 5. Panggil Backend
    google.script.run.withSuccessHandler(result => {
        btn.disabled = false;
        btn.classList.remove('cursor-not-allowed', 'opacity-75');
        btn.innerHTML = originalContent;

        if (result.success) {
            window.open(result.url, '_blank');
            showAlert('success', 'Data monitoring berhasil di-export!');
        } else {
            showAlert('error', result.message);
        }
    })
    .withFailureHandler(err => {
        btn.disabled = false;
        btn.classList.remove('cursor-not-allowed', 'opacity-75');
        btn.innerHTML = originalContent;
        showAlert('error', 'Gagal menghubungi server: ' + err);
    })
    .generateExcel('monitoring', filters);
}
    
function renderMonitoringRows(data, startIdx) {
    const tbody = document.getElementById('tbody-monitoring');
    
    // 1. Cek jika data kosong
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="p-12 text-center text-gray-400 italic bg-white">Tidak ada data ditemukan.</td></tr>';
        return;
    }

    // 2. Cek Hak Akses (Hanya Guru/Admin yang bisa edit dropdown)
    const canEdit = (currentUser.role === 'guru' || currentUser.role === 'admin');
    const cursorClass = canEdit ? 'cursor-pointer' : 'cursor-not-allowed opacity-70';
    const disabledAttr = canEdit ? '' : 'disabled';

    // 3. Render Baris Tabel
    tbody.innerHTML = data.map((d, i) => {
        
        // --- A. LOGIKA WARNA DROPDOWN STATUS (Kolom H) ---
        let statusColor = 'bg-gray-100 text-gray-600';
        if(d.status === 'Hadir') statusColor = 'bg-green-100 text-green-700';
        else if(d.status === 'Izin') statusColor = 'bg-blue-100 text-blue-700';
        else if(d.status === 'Sakit') statusColor = 'bg-yellow-100 text-yellow-700';
        else if(d.status === 'Alpa') statusColor = 'bg-red-100 text-red-700';

        // --- B. LOGIKA TAMPILAN KETERANGAN WAKTU (Kolom G) ---
        let ketText = d.keterangan || "-"; // Ambil teks dari server (misal: "Terlambat (15 m)")
        let ketStyle = "text-gray-400 font-mono text-[10px]"; // Default style
        let ketIcon = "";

        // Deteksi kata kunci dalam teks keterangan untuk memberi warna
        if (String(ketText).includes("Terlambat")) {
            // MERAH: Jika Terlambat
            ketStyle = "text-rose-600 font-bold bg-rose-50 px-2 py-1 rounded border border-rose-100 text-[10px]";
            ketIcon = '<i class="fas fa-history mr-1"></i>';
        } else if (String(ketText).includes("Pulang Cepat")) {
            // ORANYE: Jika Pulang Cepat
            ketStyle = "text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded border border-orange-100 text-[10px]";
            ketIcon = '<i class="fas fa-running mr-1"></i>';
        } else if (ketText === "Tepat Waktu") {
            // HIJAU: Jika Tepat Waktu
            ketStyle = "text-emerald-600 font-bold text-[10px]";
            ketIcon = '<i class="fas fa-check-double mr-1"></i>';
        }

        // --- C. HTML ROW ---
        return `
        <tr class="hover:bg-gray-50 border-b border-gray-50 transition group">
            <td class="p-4 text-center text-gray-400 text-xs">${startIdx + i + 1}</td>
            
            <td class="p-4">
                <div class="font-bold text-sm text-gray-900">${d.nama}</div>
                <div class="text-xs text-gray-500 font-mono">${d.nisn}</div>
            </td>
            
            <td class="p-4 text-center">
                <span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded text-xs font-bold border border-indigo-100">${d.kelas}</span>
            </td>
            
            <td class="p-4 text-center text-xs font-mono text-gray-600">${d.jamDatang}</td>
            
            <td class="p-4 text-center text-xs font-mono text-gray-600">${d.jamPulang}</td>

            <td class="p-4 text-center align-middle">
                 <span class="${ketStyle} inline-block whitespace-nowrap">${ketIcon}${ketText}</span>
            </td>

            <td class="p-4 text-center relative">
                <select onchange="changeStatus('${d.nisn}', '${d.nama}', '${d.kelas}', this)" 
                        class="text-xs font-bold py-1.5 px-2 rounded-lg border-0 focus:ring-2 focus:ring-indigo-500 shadow-sm appearance-none text-center w-32 ${statusColor} ${cursorClass}"
                        ${disabledAttr}>
                    <option value="Belum Absen" ${d.status === 'Belum Absen' ? 'selected' : ''}>Belum Absen</option>
                    <option value="Hadir" ${d.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                    <option value="Izin" ${d.status === 'Izin' ? 'selected' : ''}>Izin</option>
                    <option value="Sakit" ${d.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                    <option value="Alpa" ${d.status === 'Alpa' ? 'selected' : ''}>Alpa</option>
                </select>
                ${canEdit ? '<i class="fas fa-chevron-down absolute right-6 top-1/2 transform -translate-y-1/2 text-[10px] pointer-events-none opacity-40"></i>' : ''}
            </td>
        </tr>`;
    }).join('');
}

    // Fungsi Handler saat Guru mengubah Status
function changeStatus(nisn, nama, kelas, selectElement) {
    const newStatus = selectElement.value;
    
    // Visual Feedback: Disable sementara dropdown saat memproses
    selectElement.disabled = true;
    selectElement.style.opacity = '0.5';

    // --- KEAMANAN: AMBIL TOKEN USER ---
    const token = currentUser ? currentUser.token : null;
    // ----------------------------------

    google.script.run.withSuccessHandler(res => {
        // Aktifkan kembali dropdown
        selectElement.disabled = false;
        selectElement.style.opacity = '1';

        if (res.success) {
            // Update Warna Dropdown secara langsung agar interaktif (UI Feedback)
            let newColor = 'bg-gray-100 text-gray-600';
            if(newStatus === 'Hadir') newColor = 'bg-green-100 text-green-700';
            else if(newStatus === 'Izin') newColor = 'bg-blue-100 text-blue-700';
            else if(newStatus === 'Sakit') newColor = 'bg-yellow-100 text-yellow-700';
            else if(newStatus === 'Alpa') newColor = 'bg-red-100 text-red-700';
            
            // Reset class dan tambahkan yang baru (pertahankan base styles)
            selectElement.className = `text-xs font-bold py-1.5 px-2 rounded-lg border-0 focus:ring-2 focus:ring-indigo-500 shadow-sm appearance-none text-center w-32 cursor-pointer ${newColor}`;
            
            // Opsional: Tampilkan notifikasi kecil
            // showAlert('success', 'Status diperbarui'); 
        } else {
            // Jika gagal (misal token expired/tidak ada hak akses)
            showAlert('error', 'Gagal update: ' + res.message);
            // Reload tabel untuk mengembalikan status asli dari server
            loadMonitoringAbsensi();
        }
    })
    .withFailureHandler(error => {
        selectElement.disabled = false;
        selectElement.style.opacity = '1';
        showAlert('error', 'Error koneksi: ' + error);
    })
    .updateAbsensiStatus(token, nisn, nama, kelas, newStatus); // <-- Token dikirim
}
    // --- KARTU SISWA ---
function loadQRCodeSiswa(nisnParam, namaParam, kelasParam) {
    if (typeof stopAndBack === "function") stopAndBack(false);
    if (currentUser && currentUser.role === 'siswa' && typeof setActiveMenu === "function") {
        setActiveMenu('Kartu Saya');
    }
    if (typeof showView === "function") showView('view-kartu-siswa');

    const container = document.getElementById('kartuSiswaContainer');
    if (!container) return;

    // Ambil data mentah
    let rawNisn = nisnParam || (currentUser ? currentUser.nisn : "1234567890");
    const namaSiswa = namaParam || (currentUser ? currentUser.nama : "Siswa");
    const kelasSiswa = kelasParam || (currentUser ? currentUser.kelas : "X");
    
    // --- PERBAIKAN UTAMA: PEMBERSIH DATA (SANITIZER) ---
    // Kita hanya ambil Angka dan Huruf saja. Spasi/Simbol aneh dibuang.
    // Ini akan mengubah "3122140501(spasi)(karakter_aneh)" menjadi "3122140501" murni.
    let cleanNisn = String(rawNisn).replace(/[^a-zA-Z0-9]/g, "").trim();
    
    // Cek di Console panjang karakter aslinya (untuk debug)
    console.log("NISN Mentah:", rawNisn, "| Panjang:", String(rawNisn).length);
    console.log("NISN Bersih:", cleanNisn, "| Panjang:", cleanNisn.length);

    let backFunction = (currentUser && (currentUser.role === 'admin' || currentUser.role === 'guru')) 
                       ? "loadDataSiswa()" : "loadSiswaDashboard()";

    container.innerHTML = `
        <div class="flex justify-center items-center h-full py-12 animate-slide-up">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-sm relative transform hover:scale-[1.02] transition duration-300">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white text-center relative">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                    <h2 class="text-2xl font-bold tracking-tight">KARTU PELAJAR</h2>
                    <p class="text-xs tracking-[0.2em] uppercase opacity-80 mt-1">SMP Bina Bangsa 2</p>
                </div>
        
                <div class="p-8 text-center bg-gray-50">
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-200 inline-block mb-5">
                        <div id="myQrcode"></div>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">${namaSiswa}</h3>
                    <p class="text-indigo-600 font-mono font-bold text-lg mb-3 tracking-wider">${cleanNisn}</p>
                    <span class="inline-block px-4 py-1.5 bg-gray-200 text-gray-700 rounded-full text-sm font-bold shadow-sm">${kelasSiswa}</span>
                </div>
                
                <div class="p-5 bg-white border-t border-gray-100 flex gap-4">
                    <button onclick="window.print()" class="flex-1 bg-gray-900 text-white py-3 rounded-xl font-bold text-sm shadow hover:bg-black transition flex items-center justify-center">
                        <i class="fas fa-print mr-2"></i> Cetak
                    </button>
                    <button onclick="${backFunction}" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-xl font-bold text-sm hover:bg-gray-50 transition">
                        Tutup
                    </button>
                </div>
            </div>
        </div>`;

    setTimeout(() => {
        const qrElement = document.getElementById("myQrcode");
        if (qrElement && cleanNisn) {
            qrElement.innerHTML = ""; 
            try {
                // Hapus opsi typeNumber agar library otomatis menyesuaikan ukuran
                new QRCode(qrElement, {
                    text: cleanNisn,       // Gunakan data yang sudah dibersihkan
                    width: 160,
                    height: 160,
                    colorDark: "#1f2937",
                    colorLight: "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L  // Level L = Kapasitas Paling Besar
                });
            } catch (e) {
                console.error("Gagal generate QR:", e);
                qrElement.innerHTML = "<span class='text-red-500 text-xs'>Error Data</span>";
            }
        }
    }, 100);
}
    // --- SCANNER ---
    function loadScanAbsensi() {
        isScanning = false;
        setActiveMenu('Scan Absensi');
        showView('view-scanner');
        setTimeout(() => { startCamera('environment'); }, 500);
    }

    function startCamera(mode) {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                initCamera(mode);
            }).catch(err => initCamera(mode));
        } else {
            initCamera(mode);
        }
    }

    function initCamera(mode) {
        const loading = document.getElementById('camLoading');
        loading.classList.remove('hidden');
        
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        html5QrCode.start({ facingMode: mode }, config,
            (decodedText) => onScanSuccess(decodedText),
            (errorMessage) => { /* ignore */ }
        ).then(() => {
            loading.classList.add('hidden');
            isScanning = false;
        }).catch((err) => {
            loading.classList.add('hidden');
            const resDiv = document.getElementById('scanResult');
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-xl border border-red-100 font-bold text-sm">Gagal Mengakses Kamera: ${err}</div>`;
        });
    }

function onScanSuccess(decodedText) {
        if (!decodedText || decodedText.trim() === "" || decodedText === "undefined") return;
        if (isScanning) return; 
        isScanning = true;
        
        const resultDiv = document.getElementById('scanResult');
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = `
            <div class="bg-indigo-50 text-indigo-700 p-4 rounded-xl border border-indigo-100 flex items-center justify-center animate-pulse font-bold shadow-sm">
                <i class="fas fa-circle-notch fa-spin mr-3"></i> Memproses Data...
            </div>`;

        // ========================================================
        // UPDATE: Ambil Data Role dan Kelas User yang sedang Login
        // ========================================================
        const myRole = currentUser ? currentUser.role : '';
        const myKelas = currentUser ? currentUser.kelas : '';

        // Kirim decodedText (NISN), myRole, dan myKelas ke Server
        google.script.run.withSuccessHandler(result => {
            if (result.success) {
                const color = result.type === 'datang' ? 'green' : 'blue';
                const namaSiswa = result.nama || "Siswa";
                const kelasSiswa = result.kelas || "";

                resultDiv.innerHTML = `
                    <div class="bg-${color}-50 text-${color}-900 p-6 rounded-2xl border border-${color}-100 shadow-md animate-fade-in relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-check-circle text-6xl"></i></div>
                        <h3 class="font-bold text-xl uppercase mb-1 tracking-tight">${namaSiswa}</h3>
                        <p class="text-sm font-semibold opacity-70 mb-4">${kelasSiswa}</p>
                        <div class="bg-white/60 backdrop-blur-sm p-3 rounded-xl border border-${color}-200 inline-block">
                            <div class="text-xs uppercase tracking-widest font-bold opacity-60 mb-1">${result.message}</div>
                            <div class="text-3xl font-mono font-bold">${result.type === 'datang' ? result.jamDatang : result.jamPulang}</div>
                        </div>
                        <p class="text-xs mt-4 font-bold uppercase tracking-wide opacity-50 animate-pulse">Siap untuk siswa berikutnya...</p>
                    </div>`;
                setTimeout(() => { isScanning = false; }, 3000);
            } else {
                // Tampilan Error (Misal: Beda Kelas)
                resultDiv.innerHTML = `
                    <div class="bg-red-50 text-red-700 p-5 rounded-2xl border border-red-100 shadow-sm flex items-center space-x-4">
                        <div class="bg-red-100 p-3 rounded-full"><i class="fas fa-times text-xl"></i></div>
                        <div class="text-left">
                            <h4 class="font-bold">Gagal!</h4>
                            <p class="text-sm opacity-90">${result.message}</p>
                        </div>
                    </div>`;
                // Jeda lebih lama (4 detik) agar guru sempat membaca pesan error beda kelas
                setTimeout(() => { isScanning = false; }, 4000);
            }
        }).scanAbsensi(decodedText, myRole, myKelas); // <-- Pastikan 3 parameter dikirim
    }

    function stopAndBack(redirect = true) {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                html5QrCode = null;
                isScanning = false;
                if (redirect && currentUser) returnToDashboard();
            }).catch(() => {
                html5QrCode = null;
                if (redirect && currentUser) returnToDashboard();
            });
        } else {
            if (redirect && currentUser) returnToDashboard();
        }
    }
    
    function returnToDashboard() {
        if(currentUser.role === 'admin') loadAdminDashboard();
        else if(currentUser.role === 'guru') loadGuruDashboard();
        else loadSiswaDashboard();
    }

    // --- MODALS ---
    function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

    function showModal(content) {
        const container = document.getElementById('modalContainer');
        container.innerHTML = `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
                <div class="relative w-full max-w-2xl transform transition-all animate-fade-in">
                    ${content}
                </div>
            </div>`;
    }

    function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }

    function showAlert(type, message) {
        const bg = type === 'success' ? 'bg-green-600' : 'bg-red-600';
        const div = document.createElement('div');
        div.className = `fixed top-6 right-6 ${bg} text-white px-6 py-4 rounded-xl shadow-2xl z-[80] flex items-center font-medium animate-fade-in transform translate-y-2`;
        div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-3 text-xl"></i> ${message}`;
        document.body.appendChild(div);
        setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 300); }, 3000);
    }

    // --- MODAL GENERATORS (SISWA & GURU) ---
    function showAddSiswaModal() { showModal(createSiswaModal()); }
    function editSiswa(s) { showModal(createSiswaModal(s)); }
    
    function showAddGuruModal() { showModal(createGuruModal()); }
    function editGuru(guruData) { showModal(createGuruModal(guruData)); }

    function createSiswaModal(s = null) {
        const isEdit = s !== null;
        const inputClass = "w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 transition-all";
        const labelClass = "block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide";
        
        return `
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <h3 class="text-xl font-bold text-gray-800">${isEdit ? 'Edit Data Siswa' : 'Registrasi Siswa Baru'}</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6 max-h-[75vh] overflow-y-auto">
                <form onsubmit="saveSiswa(event, ${isEdit})" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="md:col-span-2">
                            <label class="${labelClass}">Nama Lengkap</label>
                            <input type="text" name="nama" value="${s?.nama || ''}" required class="${inputClass}" placeholder="Sesuai Akta Kelahiran">
                        </div>
                        <div>
                            <label class="${labelClass}">NISN</label>
                            <input type="number" name="nisn" value="${s?.nisn || ''}" required ${isEdit ? 'readonly class="' + inputClass + ' opacity-60 cursor-not-allowed"' : `class="${inputClass}"`} placeholder="Nomor Induk">
                        </div>
                        
                        <div class="relative group">
                            <label class="${labelClass}">Kelas</label>
                            <input type="text" name="kelas" id="inputKelas" 
                                value="${s?.kelas || ''}" 
                                required 
                                class="${inputClass}" 
                                placeholder="Ketik atau pilih kelas" 
                                autocomplete="off"
                                onfocus="openKelasDropdown()"
                                oninput="filterKelasDropdown(this.value)"
                                onblur="closeKelasDropdown()">
                            <div id="dropdownKelasList" class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-xl max-h-40 overflow-y-auto mt-1 scrollbar-hide"></div>
                        </div>

                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div>
                            <label class="${labelClass}">Jenis Kelamin</label>
                            <select name="jenisKelamin" class="${inputClass}">
                                <option value="Laki-laki" ${s?.jenisKelamin === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                                <option value="Perempuan" ${s?.jenisKelamin === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label class="${labelClass}">Tanggal Lahir</label>
                            <input type="date" name="tanggalLahir" value="${s?.tanggalLahir || ''}" required class="${inputClass}">
                        </div>
                        <div>
                            <label class="${labelClass}">Agama</label>
                            <select name="agama" class="${inputClass}">
                                <option value="Islam" ${s?.agama === 'Islam' ? 'selected' : ''}>Islam</option>
                                <option value="Kristen" ${s?.agama === 'Kristen' ? 'selected' : ''}>Kristen</option>
                                <option value="Katolik" ${s?.agama === 'Katolik' ? 'selected' : ''}>Katolik</option>
                                <option value="Hindu" ${s?.agama === 'Hindu' ? 'selected' : ''}>Hindu</option>
                                <option value="Buddha" ${s?.agama === 'Buddha' ? 'selected' : ''}>Buddha</option>
                                <option value="Lainnya" ${s?.agama === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div>
                            <label class="${labelClass}">Nama Ayah</label>
                            <input type="text" name="namaAyah" value="${s?.namaAyah || ''}" class="${inputClass}">
                        </div>
                        <div>
                            <label class="${labelClass}">Nama Ibu</label>
                            <input type="text" name="namaIbu" value="${s?.namaIbu || ''}" class="${inputClass}">
                        </div>
                        <div>
                            <label class="${labelClass}">No. Handphone</label>
                            <input type="tel" name="noHp" value="${s?.noHp || ''}" class="${inputClass}">
                        </div>
                    </div>
                    <div>
                        <label class="${labelClass}">Alamat Lengkap</label>
                        <textarea name="alamat" rows="2" class="${inputClass}">${s?.alamat || ''}</textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                        <button type="button" onclick="closeModal()" class="px-6 py-2.5 rounded-xl text-gray-600 font-medium hover:bg-gray-100 transition">Batal</button>
                        <button type="submit" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">Simpan Data</button>
                    </div>
                    ${isEdit ? `<input type="hidden" name="oldNisn" value="${s.nisn}">` : ''}
                </form>
            </div>
        </div>`;
    }

// Fungsi Trigger untuk menampilkan modal
    function viewSiswa(siswa) {
        showModal(createViewSiswaModal(siswa));
    }

    // Fungsi Generator HTML Modal Detail
    function createViewSiswaModal(s) {
        // Helper untuk styling label dan value agar rapi
        const item = (label, value, icon) => `
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fas ${icon} text-gray-400 text-xs"></i>
                    <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">${label}</span>
                </div>
                <div class="text-sm font-bold text-gray-800 break-words">${value || '-'}</div>
            </div>
        `;

        return `
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-2xl w-full animate-fade-in relative">
            
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6 text-white flex justify-between items-start">
                <div class="flex gap-4 items-center">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-2xl font-bold border-2 border-white/30 shadow-inner">
                        ${s.nama.charAt(0)}
                    </div>
                    <div>
                        <h3 class="text-xl font-bold tracking-tight">${s.nama}</h3>
                        <p class="opacity-90 text-sm flex items-center gap-2">
                            <i class="far fa-id-card"></i> ${s.nisn}
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold ml-2">${s.kelas}</span>
                        </p>
                    </div>
                </div>
                <button onclick="closeModal()" class="bg-white/10 hover:bg-white/20 p-2 rounded-lg transition text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6 max-h-[70vh] overflow-y-auto">
                
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-emerald-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-user-circle"></i> Data Pribadi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${item('Jenis Kelamin', s.jenisKelamin, 'fa-venus-mars')}
                        ${item('Tanggal Lahir', s.tanggalLahir, 'fa-birthday-cake')}
                        ${item('Agama', s.agama, 'fa-pray')}
                        ${item('No. Handphone', s.noHp, 'fa-phone')}
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-sm font-bold text-emerald-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-users"></i> Data Orang Tua
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${item('Nama Ayah', s.namaAyah, 'fa-male')}
                        ${item('Nama Ibu', s.namaIbu, 'fa-female')}
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-emerald-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt"></i> Alamat Lengkap
                    </h4>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 flex gap-3 items-start">
                        <i class="fas fa-home text-gray-400 mt-1"></i>
                        <p class="text-sm text-gray-700 leading-relaxed font-medium">
                            ${s.alamat || 'Alamat belum diisi.'}
                        </p>
                    </div>
                </div>

            </div>

            <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
                <button onclick="editSiswa(${JSON.stringify(s).replace(/"/g, '&quot;')})" class="px-5 py-2.5 bg-amber-100 text-amber-700 rounded-xl font-bold text-sm hover:bg-amber-200 transition flex items-center gap-2">
                    <i class="fas fa-edit"></i> Edit Data
                </button>
                <button onclick="closeModal()" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-300 transition">
                    Tutup
                </button>
            </div>
        </div>`;
    }

// UPDATE: Modal Guru kini memiliki input Kelas
    function createGuruModal(guru = null) {
        const isEdit = guru !== null;
        const inputClass = "w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-3 transition-all mb-4";
        
        // Generate opsi kelas dari existingClasses (Global Variable)
        let kelasOptions = '<option value="">-- Pilih Kelas (Opsional) --</option>';
        if (existingClasses && existingClasses.length > 0) {
            existingClasses.forEach(k => {
                const selected = (guru && guru.kelas === k) ? 'selected' : '';
                kelasOptions += `<option value="${k}" ${selected}>${k}</option>`;
            });
        }

        return `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative overflow-hidden">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm"><i class="fas fa-chalkboard-teacher"></i></div>
                <h3 class="font-bold text-xl text-gray-800">${isEdit ? 'Edit Akun Guru' : 'Tambah Guru'}</h3>
            </div>
            
            <form onsubmit="saveGuru(event, ${isEdit})">
                <label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Username</label>
                <input name="username" value="${guru?.username || ''}" placeholder="Username" required class="${inputClass}">
                
                <label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Password</label>
                <input name="password" value="${guru?.password || ''}" placeholder="Password" required class="${inputClass}">
                
                <label class="block mb-1 text-xs font-bold text-gray-500 uppercase">Wali Kelas Untuk</label>
                <select name="kelas" class="${inputClass}">
                    ${kelasOptions}
                </select>
                <p class="text-[10px] text-gray-400 -mt-3 mb-4">Jika dipilih, guru hanya bisa melihat siswa di kelas ini.</p>
                
                ${isEdit ? `<input type="hidden" name="oldUsername" value="${guru.username}">` : ''}

                <div class="flex gap-3 mt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Batal</button>
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95">Simpan</button>
                </div>
            </form>
        </div>`;
    }

    // --- FORM ACTIONS (SIMPAN & UPDATE) ---
    // FUNCTION UPDATE: Simpan Guru dengan Loading Button
function saveGuru(e, isEdit) {
    e.preventDefault();
    
    // 1. Ambil elemen tombol untuk efek loading
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML; 

    // 2. Ubah tampilan tombol menjadi Loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Menyimpan...';
    btn.classList.add('opacity-75', 'cursor-not-allowed');

    // 3. Ambil Data Form
    const fd = new FormData(form);
    // Tambahkan tanda kutip satu (') agar dianggap text di Excel/Sheet (mencegah format angka)
    const username = "'" + fd.get('username'); 
    const password = "'" + fd.get('password');
    const kelas = fd.get('kelas');

    // --- KEAMANAN: AMBIL TOKEN USER ---
    const token = currentUser ? currentUser.token : null;
    // ----------------------------------

    // 4. Callback saat selesai
    const onComplete = (r) => {
        // Kembalikan tombol ke kondisi semula
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');

        if (r && r.success) {
            closeModal();
            // Reset cache & reload tabel
            tableState.guru.fullData = [];
            loadDataGuru();
            showAlert('success', isEdit ? 'Data guru berhasil diperbarui' : 'Akun Guru berhasil dibuat');
        } else {
            showAlert('error', r ? r.message : 'Terjadi kesalahan tidak diketahui');
        }
    };

    // Callback jika koneksi gagal
    const onFailure = (error) => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        showAlert('error', 'Gagal koneksi server: ' + error);
    };

    // 5. Eksekusi ke Server (Kirim Token sebagai parameter pertama)
    if (isEdit) {
        const oldUsername = fd.get('oldUsername');
        google.script.run
            .withSuccessHandler(onComplete)
            .withFailureHandler(onFailure)
            .updateGuru(token, oldUsername, username, password, kelas); // <-- Token dikirim
    } else {
        google.script.run
            .withSuccessHandler(onComplete)
            .withFailureHandler(onFailure)
            .addGuru(token, username, password, kelas); // <-- Token dikirim
    }
}
    
function deleteSiswaConfirm(nisn, nama) {
        // Panggil SweetAlert untuk konfirmasi
        Swal.fire({
            title: 'Apakah Anda yakin?',
            text: `Data siswa "${nama}" akan dihapus secara permanen. Tindakan ini tidak dapat dibatalkan!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444', // Warna Merah
            cancelButtonColor: '#6B7280',  // Warna Abu
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal',
            reverseButtons: true
        }).then((result) => {
            // Jika tombol "Ya, Hapus!" diklik
            if (result.isConfirmed) {
                showLoading(); // Tampilkan loading overlay

                // === KEAMANAN: AMBIL TOKEN ===
                const token = currentUser.token; 

                // Panggil Backend dengan Token
                google.script.run.withSuccessHandler(r => {
                    hideLoading();
                    
                    if (r.success) {
                        // Refresh Tabel Siswa
                        tableState.siswa.fullData = []; // Clear cache
                        loadDataSiswa(); // Reload data
                        
                        // Pesan Sukses
                        Swal.fire(
                            'Terhapus!',
                            'Data siswa berhasil dihapus.',
                            'success'
                        );
                    } else {
                        // Pesan Gagal (Misal: Token expired atau bukan admin)
                        Swal.fire(
                            'Gagal!',
                            r.message,
                            'error'
                        );
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    Swal.fire('Error', 'Terjadi kesalahan server: ' + err, 'error');
                })
                .deleteSiswa(token, nisn); // <-- PARAMETER TOKEN DITAMBAHKAN DI SINI
            }
        });
    }
// ==========================================================================
    // FITUR IMPORT EXCEL SISWA
    // ==========================================================================
    
    function triggerImportSiswa() {
        document.getElementById('fileInputSiswa').click();
    }

function handleFileImportSiswa(input) {
        const file = input.files[0];
        if (!file) return;

        showLoading(); // Tampilkan loading overlay

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Ambil sheet pertama
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Konversi ke JSON
            // defval: "" memastikan sel kosong tetap terbaca sebagai string kosong
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

            if (jsonData.length === 0) {
                hideLoading();
                showAlert('error', 'File Excel kosong atau format salah.');
                input.value = ''; // Reset input
                return;
            }

            // === VALIDASI HEADER (DIPERBAIKI) ===
            const firstRow = jsonData[0];

            // Cek apakah ada kolom 'Nama' ATAU 'Nama Lengkap'
            const hasNama = firstRow.hasOwnProperty('Nama') || firstRow.hasOwnProperty('Nama Lengkap');
            // Cek apakah ada kolom 'NISN'
            const hasNISN = firstRow.hasOwnProperty('NISN');

            if (!hasNama || !hasNISN) {
                hideLoading();
                showAlert('error', 'Format Excel salah! Pastikan ada kolom header: Nama (atau Nama Lengkap) dan NISN.');
                input.value = '';
                return;
            }
            // ====================================

            // Kirim ke Backend
            processImportSiswa(jsonData, input);
        };

        reader.onerror = function() {
            hideLoading();
            showAlert('error', 'Gagal membaca file.');
            input.value = '';
        };

        reader.readAsArrayBuffer(file);
    }

function processImportSiswa(data, inputElement) {
        // Mapping data Excel ke Format Database
        // Menggunakan operator || (OR) agar bisa membaca variasi nama kolom
        
        const formattedData = data.map(row => {
            // Helper untuk membersihkan data string
            const clean = (val) => (val ? String(val).trim() : '');

            return {
                // Prioritas 1: Nama Lengkap, Prioritas 2: Nama
                nama: clean(row['Nama Lengkap'] || row['Nama']),
                
                // NISN (Hapus kutip jika ada)
                nisn: clean(row['NISN']).replace(/'/g, ""), 
                
                // Prioritas 1: Jenis Kelamin, Prioritas 2: JK
                jenisKelamin: clean(row['Jenis Kelamin'] || row['JK']), 
                
                // Prioritas 1: Tanggal Lahir, Prioritas 2: Tgl Lahir
                // Pastikan format di Excel Text (YYYY-MM-DD) atau Date
                tanggalLahir: clean(row['Tanggal Lahir'] || row['Tgl Lahir']), 
                
                agama: clean(row['Agama']),
                
                namaAyah: clean(row['Nama Ayah']),
                
                namaIbu: clean(row['Nama Ibu']),
                
                // Prioritas 1: No Handphone, Prioritas 2: HP, Prioritas 3: No HP
                noHp: clean(row['No Handphone'] || row['HP'] || row['No HP']),
                
                kelas: clean(row['Kelas']),
                
                alamat: clean(row['Alamat'])
            };
        });

        // Debugging: Cek data pertama di console browser jika ingin memastikan
        console.log("Data Siap Import:", formattedData[0]);

        google.script.run
            .withSuccessHandler(res => {
                hideLoading();
                inputElement.value = ''; 
                
                if (res.success) {
                    tableState.siswa.fullData = [];
                    loadDataSiswa(); 
                    let msg = `Berhasil: ${res.added}, Gagal/Duplikat: ${res.skipped}`;
                    showAlert('success', 'Import Selesai! ' + msg);
                } else {
                    showAlert('error', res.message);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                inputElement.value = '';
                showAlert('error', 'Error Server: ' + err);
            })
            .importSiswaBulk(formattedData);
    }


// ==========================================================================
    // FITUR IMPORT EXCEL GURU
    // ==========================================================================
    
    function triggerImportGuru() {
        document.getElementById('fileInputGuru').click();
    }

    function handleFileImportGuru(input) {
        const file = input.files[0];
        if (!file) return;

        showLoading(); 

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

            if (jsonData.length === 0) {
                hideLoading();
                showAlert('error', 'File Excel kosong atau format salah.');
                input.value = ''; 
                return;
            }

            // Validasi Header
            const firstRow = jsonData[0];
            // Kita cek header 'Username' dan 'Password'
            const hasUser = firstRow.hasOwnProperty('Username');
            const hasPass = firstRow.hasOwnProperty('Password');

            if (!hasUser || !hasPass) {
                hideLoading();
                showAlert('error', 'Format Excel salah! Pastikan ada kolom header: Username dan Password.');
                input.value = '';
                return;
            }

            processImportGuru(jsonData, input);
        };

        reader.onerror = function() {
            hideLoading();
            showAlert('error', 'Gagal membaca file.');
            input.value = '';
        };

        reader.readAsArrayBuffer(file);
    }

    function processImportGuru(data, inputElement) {
        // Mapping data Excel ke Format Database
        const formattedData = data.map(row => {
            const clean = (val) => (val ? String(val).trim() : '');
            return {
                username: clean(row['Username']),
                password: clean(row['Password']),
                // Opsional: Jika guru tersebut adalah Wali Kelas
                kelas: clean(row['Kelas'] || row['Wali Kelas']) 
            };
        });

        google.script.run
            .withSuccessHandler(res => {
                hideLoading();
                inputElement.value = ''; 
                
                if (res.success) {
                    tableState.guru.fullData = []; // Clear cache
                    loadDataGuru(); // Reload tabel
                    let msg = `Berhasil: ${res.added}, Gagal/Duplikat: ${res.skipped}`;
                    showAlert('success', 'Import Guru Selesai! ' + msg);
                } else {
                    showAlert('error', res.message);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                inputElement.value = '';
                showAlert('error', 'Error Server: ' + err);
            })
            .importGuruBulk(formattedData);
    }

// ==========================================
// LOGIKA REKAP BULANAN
// ==========================================

function loadMenuRekapBulanan() {
    stopAndBack(false);
    setActiveMenu('Rekap Bulanan');
    showView('view-rekap-bulanan');

    // Setup Dropdown Tahun (5 tahun ke belakang)
    const selectTahun = document.getElementById('rekapTahun');
    const currentYear = new Date().getFullYear();
    selectTahun.innerHTML = '';
    for(let i = 0; i < 5; i++) {
        let yr = currentYear - i;
        let opt = document.createElement('option');
        opt.value = yr;
        opt.text = yr;
        selectTahun.appendChild(opt);
    }

    // Setup Dropdown Bulan (Default bulan ini)
    const selectBulan = document.getElementById('rekapBulan');
    selectBulan.value = new Date().getMonth();

    // Setup Dropdown Kelas
    const selectKelas = document.getElementById('rekapKelas');
    const fillDropdown = () => {
        selectKelas.innerHTML = '<option value="">Semua Kelas</option>';
        if (existingClasses && existingClasses.length > 0) {
            existingClasses.forEach(kelas => {
                const option = document.createElement('option');
                option.value = kelas;
                option.textContent = kelas;
                selectKelas.appendChild(option);
            });
        }
    };

    if (existingClasses && existingClasses.length > 0) {
        fillDropdown();
    } else {
        google.script.run.withSuccessHandler(result => {
            if (result.success) {
                existingClasses = result.data;
                fillDropdown();
            }
        }).getKelasList();
    }
}

function loadDataRekapBulanan() {
    const bulan = document.getElementById('rekapBulan').value;
    const tahun = document.getElementById('rekapTahun').value;
    const kelas = document.getElementById('rekapKelas').value;

    const tbody = document.getElementById('tbody-rekap-bulanan');
    const thead = document.getElementById('thead-rekap-bulanan');
    
    tbody.innerHTML = '<tr><td colspan="10" class="p-8 text-center"><i class="fas fa-circle-notch fa-spin mr-2"></i>Mengambil data...</td></tr>';

    google.script.run.withSuccessHandler(res => {
        if(!res.success) {
            tbody.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-red-500">${res.message}</td></tr>`;
            return;
        }
        
        const data = res.data; // { daysInMonth, students: [...] }
        
        // 1. RENDER HEADER
        let headerHTML = '<th class="p-3 w-10 text-center bg-gray-100 sticky left-0 z-20">No</th>';
        headerHTML += '<th class="p-3 w-40 bg-gray-100 sticky left-10 z-20">Nama Siswa</th>';
        
        // Loop tanggal 1 s.d akhir bulan
        for(let d=1; d<=data.daysInMonth; d++) {
            headerHTML += `<th class="p-1 text-center w-8 text-[10px] border-l border-gray-200">${d}</th>`;
        }
        // Header Statistik
        headerHTML += '<th class="p-2 w-8 text-center bg-green-50 text-green-700 border-l">H</th>';
        headerHTML += '<th class="p-2 w-8 text-center bg-yellow-50 text-yellow-700">S</th>';
        headerHTML += '<th class="p-2 w-8 text-center bg-blue-50 text-blue-700">I</th>';
        headerHTML += '<th class="p-2 w-8 text-center bg-red-50 text-red-700">A</th>';
        headerHTML += '<th class="p-2 w-12 text-center bg-gray-100">%</th>';
        
        thead.innerHTML = headerHTML;

        // 2. RENDER BODY
        if(data.students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="40" class="p-8 text-center text-gray-400">Tidak ada data siswa.</td></tr>';
            return;
        }

        let rowsHTML = '';
        data.students.forEach((siswa, idx) => {
            let row = `<tr class="hover:bg-gray-50 border-b border-gray-100 group">`;
            row += `<td class="p-3 text-center text-gray-500 sticky left-0 bg-white group-hover:bg-gray-50 z-10">${idx+1}</td>`;
            row += `<td class="p-3 font-bold text-gray-700 text-xs sticky left-10 bg-white group-hover:bg-gray-50 z-10 truncate max-w-[150px]" title="${siswa.nama}">${siswa.nama}</td>`;
            
            // Loop Kode Harian
            siswa.dailyCodes.forEach(day => {
                let colorClass = '';
                let bgClass = '';
                if(day.isHoliday) bgClass = 'bg-red-50'; // Kolom Libur
                
                if(day.code === 'H') colorClass = 'text-green-600 font-bold';
                else if(day.code === 'S') colorClass = 'text-yellow-600 font-bold bg-yellow-50';
                else if(day.code === 'I') colorClass = 'text-blue-600 font-bold bg-blue-50';
                else if(day.code === 'A') colorClass = 'text-red-600 font-bold bg-red-50';
                else if(day.code === 'L') { colorClass = 'text-red-300'; bgClass = 'bg-red-50'; }
                
                row += `<td class="p-1 text-center text-[10px] border-l border-gray-100 ${colorClass} ${bgClass}">${day.code}</td>`;
            });

            // Statistik
            row += `<td class="p-2 text-center text-xs font-bold text-green-700 bg-green-50/30 border-l">${siswa.stats.h}</td>`;
            row += `<td class="p-2 text-center text-xs font-bold text-yellow-700 bg-yellow-50/30">${siswa.stats.s}</td>`;
            row += `<td class="p-2 text-center text-xs font-bold text-blue-700 bg-blue-50/30">${siswa.stats.i}</td>`;
            row += `<td class="p-2 text-center text-xs font-bold text-red-700 bg-red-50/30">${siswa.stats.a}</td>`;
            row += `<td class="p-2 text-center text-xs font-bold text-gray-700 bg-gray-50">${siswa.stats.percent}%</td>`;
            
            row += `</tr>`;
            rowsHTML += row;
        });
        
        tbody.innerHTML = rowsHTML;

    }).getMonthlyReportData(parseInt(bulan), parseInt(tahun), kelas);
}

function renderRekapTable(result) {
    if (!result.success) {
        document.getElementById('tbody-rekap-bulanan').innerHTML = `<tr><td colspan="100%" class="p-8 text-center text-red-500">${result.message}</td></tr>`;
        return;
    }

    const { daysInMonth, students } = result.data;
    const thead = document.getElementById('thead-rekap-bulanan');
    const tbody = document.getElementById('tbody-rekap-bulanan');

    // --- 1. GENERATE HEADER ---
    let headerHtml = `
        <th class="p-3 w-10 sticky left-0 bg-gray-100 z-20 border-r border-gray-200">No</th>
        <th class="p-3 w-64 sticky left-10 bg-gray-100 z-20 border-r border-gray-200 shadow-sm">Nama Siswa</th>
    `;
    
    // Ambil info libur dari siswa pertama (karena pola libur sama untuk semua)
    // Kita asumsikan siswa pertama ada datanya.
    const sampleDaily = students.length > 0 ? students[0].dailyCodes : [];

    // Loop Header Tanggal
    for (let d = 1; d <= daysInMonth; d++) {
        // Cek apakah hari ini libur berdasarkan data sample
        // index array mulai dari 0, tanggal mulai dari 1. Jadi index = d-1
        const dayInfo = sampleDaily[d-1]; 
        const isHoliday = dayInfo ? dayInfo.isHoliday : false;
        
        // Warna Header: Jika libur, background merah muda, teks merah
        const headerClass = isHoliday 
            ? "bg-red-50 text-red-600 border-red-100 font-bold" 
            : "bg-gray-50 text-gray-600 border-gray-200";

        headerHtml += `<th class="p-1 w-8 text-center border-l ${headerClass} text-[10px]">${d}</th>`;
    }
    
    // Header Statistik
    headerHtml += `
        <th class="p-2 w-10 text-center bg-green-50 text-green-700 border-l-2 border-gray-200">H</th>
        <th class="p-2 w-10 text-center bg-yellow-50 text-yellow-700">S</th>
        <th class="p-2 w-10 text-center bg-blue-50 text-blue-700">I</th>
        <th class="p-2 w-10 text-center bg-red-50 text-red-700">A</th>
        <th class="p-2 w-16 text-center bg-indigo-50 text-indigo-700 font-bold">%</th>
    `;
    thead.innerHTML = headerHtml;

    // --- 2. GENERATE BODY ---
    if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" class="p-8 text-center text-gray-400">Tidak ada data siswa.</td></tr>';
        return;
    }

    let bodyHtml = '';
    students.forEach((siswa, index) => {
        let dailyCells = '';
        
        siswa.dailyCodes.forEach(day => {
            let bgClass = '';
            let textClass = 'text-gray-400';
            let content = day.code;

            // LOGIKA WARNA BARU
            if (day.isHoliday) {
                // HARI LIBUR: Full Block Warna Merah Muda (Arsir)
                bgClass = 'bg-red-50 pattern-grid-lg'; // pattern opsional
                textClass = 'text-red-300 select-none'; 
                content = ''; // Kosongkan visual atau isi 'L' samar
            } else {
                // HARI EFEKTIF
                if (day.code === 'H') { 
                    bgClass = 'bg-green-100'; 
                    textClass = 'text-green-700 font-bold'; 
                }
                else if (day.code === 'S') { 
                    bgClass = 'bg-yellow-100'; 
                    textClass = 'text-yellow-700 font-bold'; 
                }
                else if (day.code === 'I') { 
                    bgClass = 'bg-blue-100'; 
                    textClass = 'text-blue-700 font-bold'; 
                }
                else if (day.code === 'A') { 
                    // ALPHA: Merah Lebih Gelap/Kontras
                    bgClass = 'bg-red-100'; 
                    textClass = 'text-red-600 font-bold'; 
                }
                else { 
                    content = '-'; 
                }
            }
            
            // Border diperhalus
            const borderClass = day.isHoliday ? 'border-red-50' : 'border-gray-100';
            dailyCells += `<td class="p-1 text-center border ${borderClass} ${bgClass} ${textClass} text-[10px]">${content}</td>`;
        });

        const stats = siswa.stats;
        const percentColor = stats.percent < 70 ? 'text-red-600' : (stats.percent < 90 ? 'text-yellow-600' : 'text-green-600');

        bodyHtml += `
            <tr class="hover:bg-gray-50 transition border-b border-gray-50">
                <td class="p-2 text-center border-r border-gray-200 sticky left-0 bg-white z-10 font-medium text-gray-500">${index + 1}</td>
                <td class="p-2 border-r border-gray-200 sticky left-10 bg-white z-10 shadow-sm whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px]" title="${siswa.nama}">
                    <div class="font-bold text-gray-700 text-xs">${siswa.nama}</div>
                    <div class="text-[10px] text-gray-400">${siswa.nisn}</div>
                </td>
                ${dailyCells}
                <td class="p-1 text-center font-bold text-green-600 bg-green-50/30 border-l-2 border-gray-100">${stats.h}</td>
                <td class="p-1 text-center font-bold text-yellow-600 bg-yellow-50/30">${stats.s}</td>
                <td class="p-1 text-center font-bold text-blue-600 bg-blue-50/30">${stats.i}</td>
                <td class="p-1 text-center font-bold text-red-600 bg-red-50/30">${stats.a}</td>
                <td class="p-1 text-center font-bold ${percentColor} bg-indigo-50 border-l border-gray-200">${stats.percent}%</td>
            </tr>
        `;
    });

    tbody.innerHTML = bodyHtml;
}

function exportRekapBulananExcel() {
    const btn = document.getElementById('btnExportRekap');
    const originalContent = btn.innerHTML;
    const bulan = document.getElementById('rekapBulan').value;
    const tahun = document.getElementById('rekapTahun').value;
    
    // AMBIL FILTER KELAS
    let kelas = document.getElementById('rekapKelas').value;
    if (currentUser.role === 'guru' && currentUser.kelas) {
        kelas = currentUser.kelas;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Loading...';

    const filters = {
        bulan: parseInt(bulan),
        tahun: parseInt(tahun),
        kelas: kelas // Kirim kelas yang dipilih
    };

    google.script.run.withSuccessHandler(result => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
        if (result.success) {
            window.open(result.url, '_blank');
        } else {
            showAlert('error', result.message);
        }
    })
    .withFailureHandler(err => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
        showAlert('error', 'Gagal: ' + err);
    })
    .generateExcel('laporan_bulanan', filters);
}

// ==========================================
// LOGIKA KENAIKAN KELAS & ARSIP
// ==========================================

function loadKenaikanKelas() {
    stopAndBack(false);
    setActiveMenu('Kenaikan Kelas');
    showView('view-kenaikan-kelas');
    
    // Reset Form
    document.getElementById('container-promo-siswa').classList.add('hidden');
    document.getElementById('promo-placeholder').classList.remove('hidden');
    
    // Init Dropdown Kelas
    const selAsal = document.getElementById('promoKelasAsal');
    const selTujuan = document.getElementById('promoKelasTujuan');
    
    // Reset options (Keep default and LULUS)
    selAsal.innerHTML = '<option value="">-- Pilih Kelas --</option>';
    selTujuan.innerHTML = '<option value="">-- Pilih Tujuan --</option><option value="LULUS" class="font-bold text-green-600">🎓 LULUS (Alumni)</option>';

    if (existingClasses && existingClasses.length > 0) {
        existingClasses.sort();
        existingClasses.forEach(c => {
            // Isi Kelas Asal
            const opt1 = document.createElement('option');
            opt1.value = c;
            opt1.text = c;
            selAsal.add(opt1);

            // Isi Kelas Tujuan
            const opt2 = document.createElement('option');
            opt2.value = c;
            opt2.text = c;
            selTujuan.add(opt2);
        });
    } else {
        // Fetch jika belum ada cache
        google.script.run.withSuccessHandler(classes => {
            existingClasses = classes;
            loadKenaikanKelas(); // Reload
        }).getDaftarKelas();
    }
}

function loadSiswaUntukPromosi() {
    const asal = document.getElementById('promoKelasAsal').value;
    const tujuan = document.getElementById('promoKelasTujuan').value;

    if (!asal || !tujuan) {
        showAlert('error', 'Harap pilih Kelas Asal dan Kelas Tujuan.');
        return;
    }

    if (asal === tujuan) {
        showAlert('error', 'Kelas Asal dan Tujuan tidak boleh sama.');
        return;
    }

    showLoading(); // Overlay loading (buat function ini jika belum ada) atau manual:
    document.getElementById('tbody-promo-siswa').innerHTML = '<tr><td colspan="4" class="p-4 text-center"><i class="fas fa-circle-notch fa-spin"></i> Mengambil data siswa...</td></tr>';
    document.getElementById('container-promo-siswa').classList.remove('hidden');
    document.getElementById('promo-placeholder').classList.add('hidden');

    google.script.run.withSuccessHandler(siswaList => {
        hideLoading();
        renderTablePromosi(siswaList, tujuan);
    }).getSiswaByKelas(asal);
}

function renderTablePromosi(siswaList, namaKelasTujuan) {
    const tbody = document.getElementById('tbody-promo-siswa');
    tbody.innerHTML = '';

    if (siswaList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
        return;
    }

    siswaList.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 transition border-b border-gray-50";
        
        // Label tombol switch
        const labelNaik = namaKelasTujuan === 'LULUS' ? 'Lulus' : 'Naik Kelas';
        const classNaik = namaKelasTujuan === 'LULUS' ? 'text-green-600' : 'text-indigo-600';
        
        tr.innerHTML = `
            <td class="p-3 text-center text-gray-500">${i + 1}</td>
            <td class="p-3 font-medium text-gray-800">${s.nama}</td>
            <td class="p-3 text-gray-500 text-xs">${s.nisn}</td>
            <td class="p-3 text-center">
                <div class="flex items-center justify-center gap-4 promo-row" data-nisn="${s.nisn}" data-nama="${s.nama}">
                    
                    <label class="cursor-pointer flex items-center gap-2 p-2 rounded-lg border border-transparent hover:bg-green-50 transition">
                        <input type="radio" name="status_${s.nisn}" value="NAIK" checked class="w-4 h-4 text-green-600 focus:ring-green-500">
                        <span class="text-xs font-bold ${classNaik}">${labelNaik}</span>
                    </label>

                    <label class="cursor-pointer flex items-center gap-2 p-2 rounded-lg border border-transparent hover:bg-red-50 transition">
                        <input type="radio" name="status_${s.nisn}" value="TINGGAL" class="w-4 h-4 text-red-600 focus:ring-red-500">
                        <span class="text-xs font-bold text-red-600">Tinggal Kelas</span>
                    </label>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function executePromotion() {
    const asal = document.getElementById('promoKelasAsal').value;
    const tujuan = document.getElementById('promoKelasTujuan').value;
    
    // Kumpulkan Data
    const rows = document.querySelectorAll('.promo-row');
    const promoData = [];
    let countNaik = 0;
    let countTinggal = 0;

    rows.forEach(row => {
        const nisn = row.getAttribute('data-nisn');
        const nama = row.getAttribute('data-nama');
        // Cari radio button yang checked dalam baris ini
        const status = document.querySelector(`input[name="status_${nisn}"]:checked`).value;
        
        promoData.push({
            nisn: nisn,
            nama: nama,
            status: status // 'NAIK' atau 'TINGGAL'
        });

        if (status === 'NAIK') countNaik++;
        else countTinggal++;
    });

    if (promoData.length === 0) return;

    Swal.fire({
        title: 'Konfirmasi Kenaikan',
        html: `
            Anda akan memproses kelas <b>${asal}</b> ke <b>${tujuan}</b>.<br><br>
            <ul class="text-left text-sm bg-gray-50 p-3 rounded">
                <li>✅ <b>${countNaik}</b> siswa Naik/Lulus</li>
                <li>❌ <b>${countTinggal}</b> siswa Tinggal Kelas</li>
            </ul>
            <br>Lanjutkan?
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#059669',
        confirmButtonText: 'Ya, Proses!'
    }).then((result) => {
        if (result.isConfirmed) {
            const btn = document.getElementById('btn-eksekusi-promo');
            const originalTxt = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Sedang memproses database...';

            google.script.run.withSuccessHandler(res => {
                btn.disabled = false;
                btn.innerHTML = originalTxt;
                
                if (res.success) {
                    Swal.fire('Berhasil!', `Data berhasil diperbarui.`, 'success');
                    // Reset View
                    loadKenaikanKelas();
                    // Refresh Cache Data Siswa
                    loadDataSiswa();
                } else {
                    Swal.fire('Gagal', res.message, 'error');
                }
            }).processIndividualPromotion(asal, tujuan, promoData);
        }
    });
}
function showModalArsip() {
    Swal.fire({
        title: 'Tutup Tahun Ajaran (Arsip)',
        html: `
            <p class="text-xs text-gray-600 mb-3">Backup data absensi ke file baru & reset database absensi utama.</p>
            <input type="text" id="swal-input-arsip" class="swal2-input" placeholder="Nama File Arsip (misal: Absensi 2024-2025)">
        `,
        showCancelButton: true,
        confirmButtonText: 'Arsipkan & Reset',
        confirmButtonColor: '#d33',
        preConfirm: () => {
            const nama = Swal.getPopup().querySelector('#swal-input-arsip').value;
            if (!nama) Swal.showValidationMessage('Nama arsip wajib diisi');
            return nama;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Panggil fungsi backend archiveAndResetYear (sama seperti sebelumnya)
            showLoading();
            google.script.run.withSuccessHandler(res => {
                hideLoading();
                if(res.success) Swal.fire('Sukses', 'Data berhasil diarsipkan', 'success');
                else Swal.fire('Gagal', res.message, 'error');
            }).archiveAndResetYear(result.value);
        }
    });
}

function showLoading() {
    Swal.fire({
        title: 'Loading...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading() }
    });
}
function hideLoading() {
    Swal.close();
}
function renderMappingTable(classes) {
    const tbody = document.getElementById('tbody-mapping-kelas');
    tbody.innerHTML = '';

    // Sort kelas agar rapi (1A, 1B, 2A...)
    classes.sort();

    classes.forEach(kelasAsal => {
        // Buat opsi dropdown untuk target kelas
        let options = `<option value="">-- Pilih --</option>`;
        options += `<option value="LULUS" class="font-bold text-red-600">🎓 LULUS (Jadi Alumni)</option>`;
        
        classes.forEach(kelasTujuan => {
            // Logika auto-select sederhana (Misal 1-A -> 2-A)
            // Ini opsional, user bisa ganti manual
            options += `<option value="${kelasTujuan}">${kelasTujuan}</option>`;
        });

        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 transition";
        tr.innerHTML = `
            <td class="p-3 font-bold text-gray-700 border-b border-gray-100">
                <input type="hidden" class="input-kelas-asal" value="${kelasAsal}">
                ${kelasAsal}
            </td>
            <td class="p-3 text-center text-gray-400 border-b border-gray-100">
                <i class="fas fa-arrow-right"></i>
            </td>
            <td class="p-3 border-b border-gray-100">
                <select class="input-kelas-tujuan w-full p-1 border border-gray-300 rounded text-sm focus:ring-indigo-500">
                    ${options}
                </select>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function processKenaikanKelas() {
    // 1. Kumpulkan Data Mapping
    const mapping = [];
    const rows = document.querySelectorAll('#tbody-mapping-kelas tr');
    let isValid = true;

    rows.forEach(row => {
        const asal = row.querySelector('.input-kelas-asal').value;
        const tujuan = row.querySelector('.input-kelas-tujuan').value;
        
        if (tujuan) {
            mapping.push({ asal: asal, tujuan: tujuan });
        }
    });

    if (mapping.length === 0) {
        showAlert('error', 'Belum ada kenaikan kelas yang dipilih.');
        return;
    }

    // 2. Konfirmasi SweetAlert
    Swal.fire({
        title: 'Konfirmasi Kenaikan?',
        text: `Anda akan memproses ${mapping.length} aturan kenaikan kelas. Data siswa akan berubah permanen!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#4F46E5',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Proses Sekarang!'
    }).then((result) => {
        if (result.isConfirmed) {
            // UI Loading
            const btn = document.getElementById('btn-proses-naik');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Memproses...';

            google.script.run.withSuccessHandler(res => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                if (res.success) {
                    Swal.fire('Berhasil!', `Data berhasil diperbarui. ${res.movedCount} siswa dipindahkan/lulus.`, 'success');
                    // Refresh data
                    loadDataSiswa(); // Refresh cache siswa
                    loadKenaikanKelas(); // Reset form
                } else {
                    Swal.fire('Gagal', res.message, 'error');
                }
            }).processGradePromotion(mapping);
        }
    });
}

function processTutupTahun() {
    const namaArsip = document.getElementById('namaArsip').value.trim();
    
    if (!namaArsip) {
        showAlert('error', 'Harap isi Label Arsip terlebih dahulu (Misal: Arsip 2024-2025)');
        return;
    }

    Swal.fire({
        title: 'TUTUP TAHUN AJARAN?',
        html: `Anda akan mengarsipkan data ke file <b>"${namaArsip}"</b> dan <span style="color:red; font-weight:bold;">MENGHAPUS SEMUA DATA ABSENSI</span> di aplikasi ini.<br><br>Tindakan ini tidak dapat dibatalkan!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#059669', // Emerald
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Saya Paham & Lanjutkan'
    }).then((result) => {
        if (result.isConfirmed) {
            const btn = document.getElementById('btn-proses-arsip');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Mengarsipkan... (Bisa memakan waktu)';

            google.script.run.withSuccessHandler(res => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                if (res.success) {
                    Swal.fire('Selesai!', `Data absensi berhasil diarsipkan ke spreadsheet baru.<br><a href="${res.url}" target="_blank" class="text-blue-600 underline">Buka Arsip</a>`, 'success');
                    document.getElementById('namaArsip').value = '';
                } else {
                    Swal.fire('Gagal', res.message, 'error');
                }
            }).archiveAndResetYear(namaArsip);
        }
    });
}


// ==========================================================================
    // FITUR IMPORT EXCEL HARI LIBUR
    // ==========================================================================
    
    function triggerImportLibur() {
        document.getElementById('fileInputLibur').click();
    }

function handleFileImportLibur(input) {
        const file = input.files[0];
        if (!file) return;

        showLoading(); 

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            
            // --- PERBAIKAN DISINI: Tambahkan cellDates: true ---
            // Opsi ini memaksa SheetJS mengubah angka Excel menjadi Date Object JS yang benar
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            // ----------------------------------------------------
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

            if (jsonData.length === 0) {
                hideLoading();
                showAlert('error', 'File Excel kosong atau format salah.');
                input.value = ''; 
                return;
            }

            // Validasi Header
            const firstRow = jsonData[0];
            const hasTanggal = firstRow.hasOwnProperty('Tanggal');
            const hasKet = firstRow.hasOwnProperty('Keterangan');

            if (!hasTanggal || !hasKet) {
                hideLoading();
                showAlert('error', 'Format Excel salah! Pastikan ada kolom header: Tanggal dan Keterangan.');
                input.value = '';
                return;
            }

            processImportLibur(jsonData, input);
        };

        reader.onerror = function() {
            hideLoading();
            showAlert('error', 'Gagal membaca file.');
            input.value = '';
        };

        reader.readAsArrayBuffer(file);
    }

function processImportLibur(data, inputElement) {
        // Helper: Mengubah Date Object JS ke string "YYYY-MM-DD"
        // Ini penting untuk mencegah tanggal mundur 1 hari karena perbedaan zona waktu
        const formatDateCorrectly = (dateInput) => {
            if (!dateInput) return "";
            
            // Jika input sudah berupa Date Object (karena cellDates: true)
            if (dateInput instanceof Date) {
                const year = dateInput.getFullYear();
                const month = String(dateInput.getMonth() + 1).padStart(2, '0');
                const day = String(dateInput.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Jika masih string, kembalikan apa adanya
            return String(dateInput).trim();
        };

        // Mapping data Excel ke Format Backend
        const formattedData = data.map(row => {
            const clean = (val) => (val ? String(val).trim() : '');
            
            // Ambil tanggal dan format ulang
            let rawTanggal = row['Tanggal'];
            let fixedTanggal = formatDateCorrectly(rawTanggal);

            return {
                tanggal: fixedTanggal, 
                keterangan: clean(row['Keterangan'])
            };
        });

        google.script.run
            .withSuccessHandler(res => {
                hideLoading();
                inputElement.value = ''; 
                
                if (res.success) {
                    loadKelolaAbsen(); 
                    let msg = `Berhasil: ${res.added}, Gagal/Duplikat: ${res.skipped}`;
                    showAlert('success', 'Import Hari Libur Selesai! ' + msg);
                } else {
                    showAlert('error', res.message);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                inputElement.value = '';
                showAlert('error', 'Error Server: ' + err);
            })
            .importHariLiburBulk(formattedData);
    }

// Tambahkan di bagian script

// ====================================
// FITUR DOWNLOAD KARTU MASSAL (BULK)
// ====================================
// 
async function downloadKartuSiswaBulk() {
    // 1. Cek Filter & Data
    const filterKelas = document.getElementById('filterKelasSiswa').value;
    // Pastikan tableState.siswa.fullData ada
    const allSiswa = (tableState.siswa && tableState.siswa.fullData) ? tableState.siswa.fullData : [];

    if (!allSiswa || allSiswa.length === 0) {
        showAlert('error', 'Data siswa belum dimuat. Refresh data dulu.');
        return;
    }

    // 2. Filter Data
    let dataToPrint = allSiswa;
    if (filterKelas && filterKelas !== "") {
        dataToPrint = allSiswa.filter(s => s.kelas === filterKelas);
    }

    if (dataToPrint.length === 0) {
        showAlert('error', 'Tidak ada siswa ditemukan.');
        return;
    }

    // Konfirmasi
    const result = await Swal.fire({
        title: 'Cetak Kartu Pelajar',
        text: `Mencetak ${dataToPrint.length} kartu. Layout: 8 Kartu per Halaman (A4).`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Cetak Sekarang',
        cancelButtonText: 'Batal'
    });
    if (!result.isConfirmed) return;

    // 3. Proses PDF
    Swal.fire({
        title: 'Generate PDF...',
        html: 'Sedang menyusun kartu...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    setTimeout(async () => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // --- KONFIGURASI GRID ---
            const pageWidth = 210;  // Lebar A4
            const pageHeight = 297; // Tinggi A4
            const cardWidth = 86;   // Lebar Kartu ID Standar
            const cardHeight = 54;  // Tinggi Kartu ID Standar
            
            // Jarak antar kartu
            const gapX = 10; 
            const gapY = 10; 

            // Hitung Margin Otomatis
            const marginX = (pageWidth - ((cardWidth * 2) + gapX)) / 2;
            const marginY = (pageHeight - ((cardHeight * 4) + (gapY * 3))) / 2;

            let x = marginX;
            let y = marginY;
            let col = 0;
            let row = 0;

            // Temp div untuk QR Generator (Hidden)
            const tempDiv = document.createElement('div');
            // Gunakan absolute off-screen agar canvas tetap ter-render dengan benar oleh browser
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '-9999px';
            document.body.appendChild(tempDiv);

            for (let i = 0; i < dataToPrint.length; i++) {
                const s = dataToPrint[i];

                // --- PERBAIKAN 1: BERSIHKAN DATA NISN (SANITIZER) ---
                // Mengambil hanya angka dan huruf, membuang spasi/karakter aneh
                let rawNisn = s.nisn || "0000";
                let cleanNisn = String(rawNisn).replace(/[^a-zA-Z0-9]/g, "").trim();

                // ==========================================
                // DESAIN KARTU
                // ==========================================

                // 1. BACKGROUND & BORDER
                doc.setDrawColor(200, 200, 200); // Abu muda
                doc.setFillColor(255, 255, 255); // Putih
                doc.roundedRect(x, y, cardWidth, cardHeight, 2, 2, 'FD');

                // 2. HEADER BIRU
                doc.setFillColor(30, 58, 138); // Navy Blue
                doc.rect(x, y, cardWidth, 14, 'F');
                
                // Teks Header
                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.text("KARTU PELAJAR", x + (cardWidth/2), y + 6, {align:'center'});
                
                doc.setFontSize(6);
                doc.setFont("helvetica", "normal");
                doc.text("SMP BINA BANGSA 2 SURABAYA", x + (cardWidth/2), y + 10, {align:'center'});

                // Garis Aksen Emas
                doc.setFillColor(245, 158, 11); // Amber
                doc.rect(x, y + 14, cardWidth, 1, 'F');

                // 3. QR CODE
                const qrSize = 22; 
                const qrX = x + 8; // Margin kiri dalam kartu
                const qrY = y + 22; 
                
                // --- PERBAIKAN 2: GENERATE QR DENGAN LEVEL 'L' ---
                tempDiv.innerHTML = ''; // Kosongkan dulu
                
                // Cek apakah data valid
                if(cleanNisn) {
                    try {
                        new QRCode(tempDiv, {
                            text: cleanNisn, // Gunakan data bersih
                            width: 120, height: 120,
                            // PENTING: Gunakan Level L agar muat data panjang tanpa error overflow
                            correctLevel: QRCode.CorrectLevel.L, 
                            colorDark : "#000000", colorLight : "#ffffff"
                        });
                        
                        // Ambil gambar dari canvas
                        const canvas = tempDiv.querySelector('canvas');
                        if(canvas) {
                            const qrUrl = canvas.toDataURL("image/png");
                            doc.addImage(qrUrl, 'PNG', qrX, qrY, qrSize, qrSize);
                        }
                    } catch (e) {
                        console.error("Gagal buat QR untuk " + s.nama, e);
                    }
                }

                // Label kecil di bawah QR
                doc.setFontSize(5);
                doc.setTextColor(100, 116, 139);
                doc.text("Scan untuk Absensi", qrX + (qrSize/2), qrY + qrSize + 3, {align:'center'});

                // 4. DATA SISWA
                const textX = x + 36; 
                
                // NAMA
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.setTextColor(30, 58, 138); 
                let namaCetak = (s.nama || "").length > 20 ? (s.nama || "").substring(0, 20) + "..." : (s.nama || "");
                doc.text(namaCetak.toUpperCase(), textX, y + 26);

                // Garis pemisah
                doc.setDrawColor(226, 232, 240);
                doc.line(textX, y + 28, x + cardWidth - 5, y + 28);

                // DETAIL
                doc.setFontSize(8);
                // NISN
                doc.setFont("helvetica", "normal");
                doc.setTextColor(100, 116, 139); 
                doc.text("NISN", textX, y + 34);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(15, 23, 42); 
                doc.text(": " + cleanNisn, textX + 14, y + 34);
                
                // KELAS
                doc.setFont("helvetica", "normal");
                doc.setTextColor(100, 116, 139);
                doc.text("Kelas", textX, y + 40);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(15, 23, 42);
                doc.text(": " + (s.kelas || "-"), textX + 14, y + 40);

                // ==========================================
                // GRID LOGIC
                // ==========================================
                col++;
                if (col >= 2) { 
                    col = 0;
                    row++;
                    x = marginX; 
                    y += cardHeight + gapY; 
                } else { 
                    x += cardWidth + gapX;
                }

                // Pindah Halaman
                if (row >= 4 && i < dataToPrint.length - 1) {
                    doc.addPage();
                    col = 0; 
                    row = 0; 
                    x = marginX; 
                    y = marginY;
                }
            }

            // Bersihkan elemen temp
            document.body.removeChild(tempDiv);
            
            const fileName = filterKelas ? `Kartu_${filterKelas}.pdf` : `Kartu_Semua_Siswa.pdf`;
            doc.save(fileName);

            Swal.fire({
                icon: 'success',
                title: 'Selesai!',
                text: 'PDF Kartu berhasil diunduh.',
                timer: 2000
            });
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Gagal membuat PDF: ' + error.message, 'error');
        }
    }, 500);
}

    function deleteGuruConfirm(username) {
        if (confirm(`Hapus akses untuk guru: ${username}?`)) {
            showLoading(); // Tampilkan overlay loading

            // --- KEAMANAN: AMBIL TOKEN USER ---
            const token = currentUser ? currentUser.token : null;
            // ----------------------------------

            google.script.run.withSuccessHandler(r => {
                hideLoading();
                
                if (r.success) {
                    // Bersihkan cache data guru
                    tableState.guru.fullData = []; 
                    // Reload tabel
                    loadDataGuru();
                    showAlert('success', 'Akun guru berhasil dihapus');
                } else {
                    showAlert('error', r.message);
                }
            })
            .withFailureHandler(error => {
                hideLoading();
                showAlert('error', 'Gagal menghapus: ' + error);
            })
            .deleteGuru(token, username); // <-- Token dikirim
        }
    }

function handleArchiveAndReset() {
        const backupNameInput = document.getElementById('backupName');
        // Ambil value dan hapus spasi berlebih
        const backupName = backupNameInput ? backupNameInput.value.trim() : ''; 

        Swal.fire({
            title: 'Tutup Tahun Ajaran?',
            text: "Sistem akan membackup data saat ini (Absensi, Siswa, Kelas) lalu MERESET data utama untuk tahun ajaran baru. Tindakan ini tidak bisa dibatalkan!",
            icon: 'warning',
            input: 'text', // Opsional: Bisa minta input lagi disini atau pakai input form sebelumnya
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Tutup & Reset!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                
                // PANGGIL BACKEND
                google.script.run
                    .withSuccessHandler(function(res) {
                        hideLoading();
                        if (res.success) {
                            Swal.fire({
                                title: 'Berhasil!',
                                text: res.message + '\nFile Backup: ' + res.backupName, // Tampilkan nama file
                                icon: 'success'
                            }).then(() => {
                                loadDashboardData(); // Refresh data
                            });
                        } else {
                            showAlert('error', res.message);
                        }
                    })
                    .withFailureHandler(function(err) {
                        hideLoading();
                        showAlert('error', 'Gagal server: ' + err);
                    })
                    .archiveAndReset(backupName); // <--- PERBAIKAN: Masukkan parameter backupName
            }
        });
    }

    // Fungsi untuk Tampilkan/Sembunyikan Password
    function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.getElementById('togglePasswordIcon');

        if (passwordInput.type === 'password') {
            // Ubah ke Text (Tampilkan)
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            // Ubah ke Password (Sembunyikan)
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }
    function downloadTemplate(type) {
        // Tampilkan loading overlay
        showLoading();
        
        google.script.run
            .withSuccessHandler(function(res) {
                hideLoading();
                if (res.success) {
                    // Buka URL download di tab baru
                    window.open(res.url, '_blank');
                    // Beri notifikasi (Opsional)
                    // showAlert('success', 'Template ' + type + ' berhasil diunduh');
                } else {
                    showAlert('error', res.message);
                }
            })
            .withFailureHandler(function(err) {
                hideLoading();
                showAlert('error', 'Gagal: ' + err);
            })
            .getTemplateExcel(type);
    }
    function generateQRForSiswa(nisn, nama, kelas) {
        loadQRCodeSiswa(nisn, nama, kelas);
    }

    // ==========================================================================
    // 10. START APP
    // ==========================================================================
    checkSession();
</script>
</body>
</html>
